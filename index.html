<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha de Personagem D&D 5e</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IM+Fell+English+SC&family=Mate+SC&family=MedievalSharp&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <style>
        /* --- Configuração Base e Modo Claro (Papiro Aprimorado) --- */
        :root {
            --bg-color: #f8f0e3; /* Mais claro, tom de papiro base */
            --text-color: #5a403a; /* Marrom escuro para texto, alta legibilidade */
            --border-color: #d4a778; /* Tom médio de papiro para bordas suaves */
            --border-strong-color: #a37c59; /* Marrom papiro mais forte para bordas principais */
            --card-bg-color: rgba(255, 255, 255, 0.7); /* Fundo dos cards quase branco com transparência */
            --accent-color: #8c5d3f; /* Marrom acentuado para botões, destaques */
            --accent-text-color: #fcf8f0; /* Texto claro para acentos escuros */
            --tab-active-bg: rgba(212, 167, 120, 0.6); /* Cor de aba ativa com transparência */
            --danger-color: #b33939; /* Vermelho queimado para perigo */
            --danger-text-color: #fcf8f0;
            --glow-color: rgba(175, 130, 90, 0.5); /* Brilho suave em tons de papiro */
            --success-color: #2b7a4b; /* Verde escuro para sucesso */
            --success-bg-color: rgba(144, 238, 144, 0.8); /* Verde claro para fundo de sucesso */
            /* Scrollbar colors for light mode */
            --scrollbar-track-color-light: rgba(212, 167, 120, 0.3); /* Lighter, more transparent */
            --scrollbar-thumb-color-light: var(--border-strong-color);

            /* Mission Status Colors */
            --quest-open-color: #d97706; /* Orange */
            --quest-completed-color: #16a34a; /* Green */
            --quest-cancelled-color: #dc2626; /* Red */

            /* NEW: Priority Colors */
            --priority-low-color: #3b82f6; /* Blue */
            --priority-medium-color: #f59e0b; /* Amber */
            --priority-high-color: #ef4444; /* Red */
            --priority-urgent-color: #8b5cf6; /* Violet */

            /* NEW: Connection Meter Colors */
            --connection-high-color: #16a34a; /* Green */
            --connection-medium-color: #f59e0b; /* Amber */
            --connection-low-color: #dc2626; /* Red */
            --connection-zero-color: #5a403a; /* Dark Brown for 0% */
        }

        /* --- Modo Noturno (Preto e Lilás Refinado) --- */
        .dark-mode {
            --bg-color: #1c1824; /* Fundo muito escuro, quase preto com tom de lilás */
            --text-color: #e6e0f0; /* Texto muito claro para alto contraste */
            --border-color: #9370db; /* Lilás vibrante para bordas suaves */
            --border-strong-color: #b08fe6; /* Lilás mais claro e forte para bordas principais */
            --card-bg-color: rgba(28, 24, 36, 0.75); /* Fundo dos cards escuro com transparência */
            --accent-color: #b08fe6; /* Lilás principal para acento */
            --accent-text-color: #1c1824; /* Texto escuro para acentos claros */
            --tab-active-bg: rgba(147, 112, 219, 0.5); /* Lilás de aba ativa com transparência */
            --danger-color: #e06c75; /* Tom de vermelho que contrasta bem com lilás */
            --danger-text-color: #1c1824;
            --glow-color: rgba(176, 143, 230, 0.4); /* Brilho lilás suave */
            --success-color: #60c790; /* Verde menta para sucesso, mais visível no escuro */
            --success-bg-color: rgba(96, 199, 144, 0.3); /* Fundo verde transparente */
            /* Scrollbar colors for dark mode */
            --scrollbar-track-color-dark: rgba(147, 112, 219, 0.2); /* Darker, more transparent */
            --scrollbar-thumb-color-dark: var(--accent-color);

            /* Mission Status Colors Dark Mode */
            --quest-open-color: #fcd34d; /* Yellow */
            --quest-completed-color: #60c790; /* Green */
            --quest-cancelled-color: #ef4444; /* Red */

            /* NEW: Priority Colors Dark Mode */
            --priority-low-color: #60a5fa; /* Light Blue */
            --priority-medium-color: #fbbf24; /* Yellow */
            --priority-high-color: #f87171; /* Light Red */
            --priority-urgent-color: #c4b5fd; /* Light Violet */

            /* NEW: Connection Meter Colors Dark Mode */
            --connection-high-color: #60c790; /* Green */
            --connection-medium-color: #fbbf24; /* Yellow */
            --connection-low-color: #ef4444; /* Red */
            --connection-zero-color: #e6e0f0; /* Light text color for 0% in dark mode */
        }

        body {
            background-color: var(--bg-color);
            background-image: url('https://www.transparenttextures.com/patterns/old-wall.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            font-family: 'Mate SC', serif;
            color: var(--text-color);
            transition: background-color 0.5s, color 0.5s;
        }
        .font-ornate { font-family: 'IM Fell English SC', serif; }
        
        /* --- Layout de Papiro --- */
        .parchment-container {
            border-style: solid;
            border-width: 25px;
            /* SVG de papiro para tema claro */
            border-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='75' height='75'%3E%3Cpath d='M0 0 H 25 V 10 H 10 V 25 H 0 Z' fill='%23a37c59'/%3E%3Cpath d='M25 0 H 50 V 25 H 40 V 15 H 30 V 25 H 25 Z' fill='%23a37c59'/%3E%3Cpath d='M50 0 H 75 V 25 H 60 V 5 H 50 Z' fill='%23a37c59'/%3E%3Cpath d='M0 25 H 15 V 35 H 5 V 50 H 0 Z' fill='%23a37c59'/%3E%3Cpath d='M25 25 H 50 V 50 H 35 V 40 H 45 V 30 H 25 Z' fill='%23a37c59'/%3E%3Cpath d='M50 25 H 75 V 40 H 60 V 50 H 50 Z' fill='%23a37c59'/%3E%3Cpath d='M0 50 H 25 V 60 H 10 V 75 H 0 Z' fill='%23a37c59'/%3E%3Cpath d='M25 50 H 50 V 75 H 40 V 65 H 30 V 75 H 25 Z' fill='%23a37c59'/%3E%3Cpath d='M50 50 H 75 V 75 H 65 V 60 H 50 Z' fill='%23a37c59'/%3E%3C/svg%3E") 25;
            border-image-outset: 5px;
        }
        .dark-mode .parchment-container {
            /* SVG de papiro para tema escuro */
            border-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='75' height='75'%3E%3Cpath d='M0 0 H 25 V 10 H 10 V 25 H 0 Z' fill='%23b08fe6'/%3E%3Cpath d='M25 0 H 50 V 25 H 40 V 15 H 30 V 25 H 25 Z' fill='%23b08fe6'/%3E%3Cpath d='M50 0 H 75 V 25 H 60 V 5 H 50 Z' fill='%23b08fe6'/%3E%3Cpath d='M0 25 H 15 V 35 H 5 V 50 H 0 Z' fill='%23b08fe6'/%3E%3Cpath d='M25 25 H 50 V 50 H 35 V 40 H 45 V 30 H 25 Z' fill='%23b08fe6'/%3E%3Cpath d='M50 25 H 75 V 40 H 60 V 50 H 50 Z' fill='%23b08fe6'/%3E%3Cpath d='M0 50 H 25 V 60 H 10 V 75 H 0 Z' fill='%23b08fe6'/%3E%3Cpath d='M25 50 H 50 V 75 H 40 V 65 H 30 V 75 H 25 Z' fill='%23b08fe6'/%3E%3Cpath d='M50 50 H 75 V 75 H 65 V 60 H 50 Z' fill='%23b08fe6'/%3E%3C/svg%3E") 25;
            border-image-outset: 5px;
        }

        /* --- Efeito de Brilho --- */
        .glow-effect { box-shadow: 0 0 8px 2px var(--glow-color), 0 0 12px 3px var(--accent-color) inset; }
        .action-button:hover, .proficiency-toggle.proficient, .proficiency-toggle.expertise, .advantage-toggle.active, #inspiration-tracker.active { box-shadow: 0 0 8px 2px var(--glow-color); }

        /* --- Animação do Ícone do Personagem --- */
        #char-img-preview { transition: transform 0.3s ease-in-out; }
        label[for="char-img-input"]:hover #char-img-preview { transform: scale(1.1); }

        /* --- Animação das Abas --- */
        .tab-button { display: flex; align-items: center; padding: 0.5rem; border-radius: 0.5rem 0.5rem 0 0; transition: all 0.3s; }
        .tab-button .tab-text { max-width: 0; opacity: 0; overflow: hidden; white-space: nowrap; transition: max-width 0.4s ease-in-out, opacity 0.4s ease-in-out, margin-left 0.4s ease-in-out; margin-left: 0; }
        .tab-button:hover .tab-text, .tab-button.active .tab-text { max-width: 150px; opacity: 1; margin-left: 0.5rem; }
        .tab-button.active { background-color: var(--tab-active-bg); border-bottom: 2px solid var(--border-strong-color); }

        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .paper-bg { background-color: var(--card-bg-color); border: 1px solid var(--border-color); box-shadow: 0 0 15px rgba(0,0,0,0.3); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); transition: background-color 0.5s, border-color 0.5s; }
        
        /* --- Correção do Cursor de Digitação e Outline --- */
        /* Remove outline e caret-color de TODOS os elementos por padrão */
        *:focus {
            outline: none !important; /* Usar !important para garantir sobreposição em casos de especificidade */
            caret-color: transparent !important; /* Torna a barra de digitação invisível por padrão */
        }

        /* Impede a seleção de texto e cursor em elementos não-interativos */
        h1, h2, h3, h4, h5, h6,
        p, span, div:not([contenteditable="true"]),
        label, .dice-button, .num-input-control,
        .proficiency-toggle, .advantage-toggle, .death-save,
        .condition-token, #inspiration-tracker,
        .tab-button, .action-button, .danger-button,
        .equipped-slot, .item-select-card,
        .spell-level-header, .spell-slot-tick, .spell-card {
            user-select: none; /* Impede a seleção de texto */
            -webkit-user-select: none; /* Para compatibilidade com navegadores WebKit */
            -moz-user-select: none; /* Para compatibilidade com Firefox */
            -ms-user-select: none; /* Para compatibilidade com IE/Edge */
            cursor: default; /* Define o cursor padrão para evitar o cursor de texto */
            caret-color: transparent !important; /* Garante que o cursor não apareça */
        }

        /* Restaura o cursor de texto e outline APENAS para inputs e textareas editáveis */
        input[type="text"]:focus,
        input[type="number"]:focus,
        textarea:focus {
            outline: 1px solid var(--accent-color) !important; /* Mantém seu estilo de outline */
            outline-offset: 1px;
            border-radius: 4px;
            caret-color: var(--text-color) !important; /* Restaura a cor da barra de digitação */
            cursor: text !important; /* Define o cursor como texto para campos editáveis */
        }

        /* Estilos base para inputs */
        .input-base { 
            background-color: transparent; 
            border: none; 
            border-bottom: 1px solid var(--border-strong-color); 
            text-align: center; 
            width: 100%; 
            color: var(--text-color); 
        }
        
        /* Override para textareas que devem ter borda completa */
        textarea.input-base { 
            text-align: left; 
            padding: 4px; 
            border: 1px solid var(--border-strong-color); 
            border-radius: 4px; 
        }
        textarea.input-base:focus {
            border: 1px solid var(--accent-color);
            /* O outline e caret-color já são tratados pela regra geral de input/textarea:focus */
        }

        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        .num-input-control { cursor: pointer; font-size: 1.2rem; line-height: 1; padding: 0 0.25rem; color: var(--border-strong-color); transition: color 0.2s; user-select: none; }
        .num-input-control:hover { color: var(--accent-color); }

        .proficiency-toggle, .advantage-toggle { width: 18px; height: 18px; border: 1px solid var(--border-strong-color); border-radius: 50%; cursor: pointer; display: inline-flex; justify-content: center; align-items: center; font-size: 10px; font-weight: bold; transition: all 0.2s ease-in-out; user-select: none; }
        .proficiency-toggle.proficient { background-color: var(--accent-color); color: var(--accent-text-color); }
        .proficiency-toggle.expertise { background-color: var(--border-color); color: var(--accent-color); border-color: var(--accent-color); }
        .dark-mode .proficiency-toggle.expertise { color: var(--accent-text-color); }
        /* Advantage Toggle - Change 'A' to 'V' */
        .advantage-toggle { content: "V"; } /* Initial content for "Vantagem" */
        .advantage-toggle.active { background-color: var(--accent-color); color: var(--accent-text-color); }
        /* Add :before pseudo-element for the 'V' character if not already done */
        .advantage-toggle:not(.active):before { content: "V"; color: var(--text-color); opacity: 0.4; }
        .advantage-toggle.active:before { content: "V"; color: var(--accent-text-color); }


        .death-save { width: 20px; height: 20px; border: 1px solid var(--border-strong-color); border-radius: 50%; cursor: pointer; }
        .death-save.filled { background-color: var(--accent-color); }
        
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: var(--bg-color); margin: 5% auto; padding: 20px; border: 1px solid var(--border-color); width: 80%; max-width: 600px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.4); }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-button:hover, .close-button:focus { color: var(--text-color); text-decoration: none; cursor: pointer; }
        
        .action-button { background-color: var(--border-strong-color); color: var(--accent-text-color); transition: background-color 0.3s, box-shadow 0.3s; }
        .danger-button { background-color: var(--danger-color); color: var(--danger-text-color); }
        
        /* --- Toast / Popup de Notificação --- */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 200; }
        .toast { padding: 15px 20px; border-radius: 8px; margin-bottom: 10px; font-size: 1rem; color: var(--accent-text-color); animation: fadeInOut 3s forwards; }
        .toast.success { background-color: var(--success-bg-color); color: var(--success-color); border: 1px solid var(--success-color); }
        .toast.error { background-color: rgba(220, 38, 38, 0.8); color: var(--danger-text-color); border: 1px solid var(--danger-color); }
        @keyframes fadeInOut { 0% { opacity: 0; transform: translateX(100%); } 15% { opacity: 1; transform: translateX(0); } 85% { opacity: 1; transform: translateX(0); } 100% { opacity: 0; transform: translateX(100%); } }
        
        /* --- Barra de Vida --- */
        .hp-bar-container { width: 90%; margin-left: auto; margin-right: auto; height: 12px; background-color: rgba(0,0,0,0.2); border: 1px solid var(--border-strong-color); border-radius: 6px; padding: 2px; }
        .hp-bar-fill { height: 100%; border-radius: 4px; background-color: #16a34a; /* Verde por padrão */ width: 100%; transition: width 0.5s ease-in-out, background-color 0.5s ease-in-out; }
        
        /* --- Usos de Habilidade --- */
        .ability-use-tick.used { background-color: var(--accent-color); }
        
        /* --- Animação de Atributo --- */
        @keyframes flash { 0%, 100% { color: var(--text-color); transform: scale(1); } 50% { color: var(--accent-color); transform: scale(1.2); } }
        .modifier-flash { animation: flash 0.6s ease-in-out; }

        /* --- Ícones de Condição --- */
        .condition-token { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background-color: rgba(0,0,0,0.1); border: 1px solid var(--border-color); cursor: pointer; transition: all 0.3s; }
        .condition-token i { font-size: 1.2rem; color: var(--text-color); opacity: 0.4; transition: all 0.3s; }
        .condition-token.active { background-color: var(--danger-color); border-color: var(--danger-color); box-shadow: 0 0 8px 1px var(--danger-color); }
        .condition-token.active i { opacity: 1; color: var(--danger-text-color); transform: scale(1.1); }

        /* --- Estilos do Rolador de Dados --- */
        .dice-button {
            background-color: var(--border-strong-color);
            color: var(--accent-text-color);
            font-family: 'IM Fell English SC', serif;
            font-size: 1.2rem;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s, box-shadow 0.3s;
            cursor: pointer;
            border: none;
        }
        .dice-button:hover {
            background-color: var(--accent-color);
            box-shadow: 0 0 8px 2px var(--glow-color);
        }
        #dice-result {
            font-family: 'IM Fell English SC', serif;
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--accent-color);
            min-height: 3rem; /* Garante espaço mesmo sem resultado */
        }

        /* Estilos para o grimório (seção de magias) */
        .spell-level-header {
            background-color: var(--tab-active-bg);
            border-bottom: 2px solid var(--border-strong-color);
            padding: 0.5rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .spell-level-content {
            display: none;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        .spell-level-content.active {
            display: block;
        }
        .spell-slot-tick {
            width: 20px;
            height: 20px;
            border: 1px solid var(--border-strong-color);
            border-radius: 50%;
            cursor: pointer;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            background-color: rgba(0,0,0,0.1);
        }
        .spell-slot-tick.used {
            background-color: var(--accent-color);
        }
        .spell-card {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            position: relative;
        }
        .spell-card h4 {
            font-family: 'IM Fell English SC', serif;
            font-size: 1.2rem;
            margin-bottom: 0.25rem;
        }
        .spell-card p {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        /* Estilos para os botões de filtro de habilidade */
        .ability-filter-button {
            background-color: var(--border-color);
            color: var(--text-color);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s, transform 0.1s ease-out; /* Add transform for bounce */
            font-weight: bold;
        }
        .ability-filter-button.active {
            background-color: var(--accent-color);
            color: var(--accent-text-color);
            box-shadow: 0 0 8px 2px var(--glow-color); /* Add glow effect to active button */
            transform: scale(1.05); /* Slight bounce on active */
        }
        .ability-filter-button:hover:not(.active) { /* Only hover if not active */
            background-color: var(--accent-color);
            color: var(--accent-text-color);
            transform: translateY(-2px); /* Slight lift on hover */
        }

        /* Estilos para truncar texto no cartão de habilidade */
        .ability-card-description {
            display: -webkit-box;
            -webkit-line-clamp: 3; /* Limita a 3 linhas */
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: pre-wrap; /* Mantém quebras de linha mas trunca */
        }
        /* Ajustes para o modal de visualização de habilidade */
        #ability-view-modal .modal-content {
            max-width: 800px; /* Um pouco mais largo para texto */
        }
        #ability-view-modal .modal-header {
            border-bottom: 2px solid var(--border-strong-color);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        #ability-view-modal .modal-body {
            max-height: 70vh; /* Altura máxima para rolagem */
            overflow-y: auto;
            word-wrap: break-word; /* Quebra palavras longas para evitar overflow */
            overflow-wrap: break-word; /* Compatibilidade extra */
            white-space: pre-wrap; /* Mantém as quebras de linha do input */
            /* Removed padding-right: 1rem; as it adds an unnecessary space when no scrollbar is present */
        }
        #ability-view-modal .modal-body p {
            margin-bottom: 0.75rem; /* Espaçamento entre parágrafos no modal */
        }
        #ability-view-modal .modal-title {
            font-family: 'IM Fell English SC', serif;
            font-size: 2.5rem;
            color: var(--accent-color);
            margin-top: 0.25rem;
        }
        #ability-view-modal .modal-category {
            font-size: 1.1rem;
            opacity: 0.7;
            margin-top: 0.25rem;
        }

        /* Quill Editor specific styles */
        .quill-editor-container {
            border: 1px solid var(--border-strong-color);
            border-radius: 4px;
            margin-bottom: 1rem;
            background-color: var(--card-bg-color); /* Matches paper-bg */
        }
        .quill-editor-container .ql-editor {
            min-height: 100px; /* Default height */
            color: var(--text-color); /* Inherit text color */
            caret-color: var(--text-color) !important; /* Adicionado: Garante que a barra de digitação seja visível no editor Quill */
            user-select: text !important; /* Permite seleção de texto no editor */
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            cursor: text !important;
        }
        .quill-editor-container .ql-toolbar {
            border-bottom: 1px solid var(--border-strong-color);
            background-color: var(--tab-active-bg); /* Matches tab-active-bg */
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
            user-select: none !important; /* Impede seleção na barra de ferramentas do Quill */
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
            cursor: default !important;
        }
        .quill-editor-container .ql-container {
            border: none;
        }
        .quill-editor-container.h-24 .ql-editor {
            min-height: 96px; /* h-24 equivalent */
            max-height: 96px;
            overflow-y: auto;
        }
        .quill-editor-container.min-h-\[400px\] .ql-editor {
            min-height: 396px; /* min-h-[400px] equivalent */
            max-height: 396px;
            overflow-y: auto;
        }
        .quill-editor-container.min-h-\[160px\] .ql-editor {
            min-height: 156px; /* min-h-[160px] equivalent */
            max-height: 156px;
            overflow-y: auto;
        }

        /* Ensure Quill's focus outline matches custom focus style */
        /* Use :focus-within for the parent container of Quill to apply outline */
        .quill-editor-container:focus-within {
            border-color: var(--accent-color);
            outline: 1px solid var(--accent-color) !important;
            outline-offset: 1px;
            border-radius: 4px;
        }
        .quill-editor-container {
            border: 1px solid var(--border-strong-color); /* Start with defined border */
        }
        
        /* Override Quill's default colors for better dark mode contrast */
        .dark-mode .ql-snow .ql-stroke {
            stroke: var(--text-color); /* For icons */
        }
        .dark-mode .ql-snow .ql-fill {
            fill: var(--text-color); /* For some icons */
        }
        .dark-mode .ql-snow .ql-picker {
            color: var(--text-color); /* For text in pickers */
        }
        .dark-mode .ql-snow .ql-picker-options { /* Corrected selector for dropdown options */
            background-color: var(--card-bg-color); /* Background for dropdown options */
            border: 1px solid var(--border-strong-color); /* Border for dropdown options */
        }
        .dark-mode .ql-snow .ql-picker-item:hover, /* Hover state for dropdown items */
        .dark-mode .ql-snow .ql-picker-item.ql-selected { /* Selected state for dropdown items */
            background-color: var(--tab-active-bg);
            color: var(--accent-text-color);
        }
        .dark-mode .ql-snow .ql-picker-label { /* Text/label of the picker */
            color: var(--text-color);
        }
        .dark-mode .ql-snow .ql-picker-label:hover {
            background-color: rgba(255,255,255,0.1); /* Subtle hover for labels */
        }
        .dark-mode .ql-snow .ql-active { /* Active button state */
            background-color: var(--accent-color);
            color: var(--accent-text-color);
        }
        /* Adjust active state stroke/fill */
        .dark-mode .ql-snow .ql-active .ql-fill {
            fill: var(--accent-text-color); 
        }
        .dark-mode .ql-snow .ql-active .ql-stroke {
            stroke: var(--accent-text-color);
        }
        /* Placeholder color for Quill Editor */
        .quill-editor-container .ql-editor.ql-blank::before {
            color: var(--text-color); /* Default placeholder color */
            opacity: 0.6; /* Semi-transparent */
        }
        .dark-mode .quill-editor-container .ql-editor.ql-blank::before {
            color: var(--text-color); /* Brighter for dark mode */
            opacity: 0.4; /* Slightly more transparent in dark mode */
        }


        /* Tailwind typography plugin classes for rendering rich text content */
        /* To make Quill content render nicely within other elements, add 'prose' or 'prose-sm' to the parent */
        .prose-sm :where(p):not(:where([class~="not-prose"] *)),
        .prose-sm :where(li):not(:where([class~="not-prose"] *)) {
            margin-top: 0.5em;
            margin-bottom: 0.5em;
        }
        .prose-sm :where(ul):not(:where([class~="not-prose"] *)),
        .prose-sm :where(ol):not(:where([class~="not-prose"] *)) {
            margin-top: 0.75em;
            margin-bottom: 0.75em;
            padding-left: 1.2em;
        }
        /* Style for Equipped Item Slot */
        .equipped-slot {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.75rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            min-height: 100px; /* Ensure consistent height */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .equipped-slot:hover {
            box-shadow: 0 0 8px 1px var(--glow-color);
        }
        .equipped-slot .slot-label {
            font-family: 'IM Fell English SC', serif;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        .equipped-slot .slot-name {
            font-weight: bold;
            color: var(--accent-color);
            margin-top: 0.25rem;
            min-height: 1.5rem; /* Reserve space for name */
        }
        .equipped-slot .clear-button {
            font-size: 0.8rem;
            color: var(--danger-color);
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .equipped-slot:hover .clear-button {
            opacity: 1;
        }
        .equipped-slot.empty .slot-name {
            color: var(--text-color);
            opacity: 0.6;
        }

        /* Style for Coin Section */
        .coin-display {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px dashed var(--border-color);
        }
        .coin-display:last-child {
            border-bottom: none;
        }
        .coin-display i {
            font-size: 1.2rem;
            margin-right: 0.5rem;
            color: var(--accent-color);
        }
        .coin-display input {
            text-align: right;
            border: none;
            background-color: transparent;
            font-size: 1.1rem;
            padding: 0 0.25rem;
            color: var(--text-color);
            width: 80px; /* Fixed width for coin input */
        }
        .coin-display input:focus {
            border-bottom: 1px solid var(--accent-color);
            outline: none;
        }

        /* Style for item selection modal */
        .item-select-list {
            max-height: 50vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.5rem;
            background-color: var(--tab-active-bg);
        }
        .item-select-card {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .item-select-card:last-child {
            border-bottom: none;
        }
        .item-select-card:hover {
            background-color: rgba(0,0,0,0.1);
        }
        .item-select-card img {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 0.25rem;
            margin-right: 0.75rem;
            border: 1px solid var(--border-strong-color);
        }
        .item-select-card .item-select-name {
            font-weight: bold;
        }
        .item-select-card .item-select-type {
            font-size: 0.8rem;
            opacity: 0.7;
        }

        /* --- Custom Scrollbar Styles for Quill Editors and Modals --- */
        /* For Webkit (Chrome, Safari, Edge) */
        .quill-editor-container .ql-editor::-webkit-scrollbar,
        .modal-body::-webkit-scrollbar,
        .item-select-list::-webkit-scrollbar,
        .quest-card-description::-webkit-scrollbar { /* Adicionado para a descrição da missão */
            width: 0; /* Hidden by default */
            transition: width 0.3s ease-in-out; /* Smooth transition for width */
        }

        .quill-editor-container .ql-editor:hover::-webkit-scrollbar,
        .quill-editor-container .ql-editor:focus-within::-webkit-scrollbar, /* Show on focus-within for parent */
        .modal-body:hover::-webkit-scrollbar,
        .item-select-list:hover::-webkit-scrollbar,
        .quest-card-description:hover::-webkit-scrollbar { /* Adicionado para a descrição da missão */
            width: 8px; /* Show on hover */
        }

        .quill-editor-container .ql-editor::-webkit-scrollbar-track,
        .modal-body::-webkit-scrollbar-track,
        .item-select-list::-webkit-scrollbar-track,
        .quest-card-description::-webkit-scrollbar-track { /* Adicionado para a descrição da missão */
            background: var(--scrollbar-track-color-light); /* Light mode track color */
            border-radius: 10px;
        }

        .dark-mode .quill-editor-container .ql-editor::-webkit-scrollbar-track,
        .dark-mode .modal-body::-webkit-scrollbar-track,
        .dark-mode .item-select-list::-webkit-scrollbar-track,
        .dark-mode .quest-card-description::-webkit-scrollbar-track { /* Adicionado para a descrição da missão */
            background: var(--scrollbar-track-color-dark); /* Dark mode track color */
        }

        .quill-editor-container .ql-editor::-webkit-scrollbar-thumb,
        .modal-body::-webkit-scrollbar-thumb,
        .item-select-list::-webkit-scrollbar-thumb,
        .quest-card-description::-webkit-scrollbar-thumb { /* Adicionado para a descrição da missão */
            background-color: var(--scrollbar-thumb-color-light); /* Light mode thumb color */
            border-radius: 10px;
            border: 2px solid transparent; /* Gives a slight padding effect */
            background-clip: padding-box; /* Ensures border is inside */
            opacity: 0; /* Hidden by default */
            transition: opacity 0.3s ease-in-out; /* Smooth transition for opacity */
        }

        .quill-editor-container .ql-editor:hover::-webkit-scrollbar-thumb,
        .quill-editor-container .ql-editor:focus-within::-webkit-scrollbar-thumb, /* Show on focus-within for parent */
        .modal-body:hover::-webkit-scrollbar-thumb,
        .item-select-list:hover::-webkit-scrollbar-thumb,
        .quest-card-description:hover::-webkit-scrollbar-thumb { /* Adicionado para a descrição da missão */
            opacity: 1; /* Show on hover */
        }

        .dark-mode .quill-editor-container .ql-editor::-webkit-scrollbar-thumb,
        .dark-mode .modal-body::-webkit-scrollbar-thumb,
        .dark-mode .item-select-list::-webkit-scrollbar-thumb,
        .dark-mode .quest-card-description:hover::-webkit-scrollbar-thumb { /* Adicionado para a descrição da missão */
            background-color: var(--scrollbar-thumb-color-dark); /* Dark mode thumb color */
        }

        /* For Firefox */
        .quill-editor-container .ql-editor,
        .modal-body,
        .item-select-list,
        .quest-card-description { /* Adicionado para a descrição da missão */
            scrollbar-width: none; /* Hide scrollbar by default in Firefox */
            scrollbar-color: transparent transparent; /* Hide scrollbar by default */
            transition: scrollbar-color 0.3s ease-in-out, scrollbar-width 0.3s ease-in-out;
        }

        .quill-editor-container:hover .ql-editor,
        .quill-editor-container:focus-within .ql-editor, /* Show on focus-within for parent */
        .modal-body:hover,
        .item-select-list:hover,
        .quest-card-description:hover { /* Adicionado para a descrição da missão */
            scrollbar-width: thin; /* Show thin scrollbar on hover */
            scrollbar-color: var(--scrollbar-thumb-color-light) var(--scrollbar-track-color-light);
        }

        .dark-mode .quill-editor-container:hover .ql-editor,
        .dark-mode .quill-editor-container:focus-within .ql-editor,
        .dark-mode .modal-body:hover,
        .dark-mode .item-select-list:hover,
        .dark-mode .quest-card-description:hover { /* Adicionado para a descrição da missão */
            scrollbar-color: var(--scrollbar-thumb-color-dark) var(--scrollbar-track-color-dark);
        }
        /* --- End Custom Scrollbar Styles --- */

        /* Mission Specific Styles */
        .quest-card {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 1rem;
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }

        .quest-card:hover {
            box-shadow: 0 0 10px 2px var(--glow-color);
        }

        .quest-card h4 {
            font-family: 'IM Fell English SC', serif;
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .quest-card-status {
            font-size: 0.9rem;
            font-weight: bold;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            display: inline-block;
            margin-bottom: 0.5rem;
            color: var(--accent-text-color);
        }

        .quest-card-status.open {
            background-color: var(--quest-open-color);
        }
        .quest-card-status.completed {
            background-color: var(--quest-completed-color);
        }
        .quest-card-status.cancelled {
            background-color: var(--quest-cancelled-color);
        }

        /* NEW: Priority Tags for Quests */
        .quest-priority-tag {
            font-size: 0.8rem;
            font-weight: bold;
            padding: 0.15rem 0.4rem;
            border-radius: 0.2rem;
            display: inline-block;
            margin-left: 0.5rem;
            color: #ffffff; /* White text for all priority tags */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3); /* Slight text shadow for readability */
        }

        .quest-priority-tag.low { background-color: var(--priority-low-color); }
        .quest-priority-tag.medium { background-color: var(--priority-medium-color); }
        .quest-priority-tag.high { background-color: var(--priority-high-color); }
        .quest-priority-tag.urgent { background-color: var(--priority-urgent-color); }


        .quest-card-description {
            font-size: 0.9rem;
            opacity: 0.8;
            height: 60px; /* Fixed height for truncated description */
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3; /* Limit to 3 lines */
            -webkit-box-orient: vertical;
            white-space: pre-wrap;
        }
        
        .quest-actions {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: flex;
            gap: 0.25rem;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }

        .quest-card:hover .quest-actions {
            opacity: 1;
        }

        .quest-actions button {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            padding: 0.25rem;
            font-size: 1.1rem;
            transition: color 0.2s;
        }

        .quest-actions button:hover {
            color: var(--accent-color);
        }

        .quest-actions .delete-btn:hover {
            color: var(--danger-color);
        }

        /* Quest Reminder Popup */
        #quest-reminder-popup {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-strong-color);
            border-radius: 0.5rem;
            padding: 1rem;
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            flex-direction: column; /* Ensure content stacks vertically */
            display: flex; /* Override hidden for styling */
            animation: fadeIn 0.5s ease-out forwards;
        }

        #quest-reminder-popup.hidden {
            animation: fadeOut 0.5s ease-out forwards;
            pointer-events: none; /* Prevent interaction when fading out */
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(20px); }
        }

        #quest-reminder-popup h3 {
            font-family: 'IM Fell English SC', serif;
            font-size: 1.5rem;
            color: var(--accent-color);
            margin-bottom: 0.75rem;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }

        #quest-reminder-popup ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #quest-reminder-popup li {
            padding: 0.5rem 0;
            border-bottom: 1px dashed var(--border-color);
            font-size: 0.95rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* Allow priority tag to wrap if needed */
        }

        #quest-reminder-popup li:last-child {
            border-bottom: none;
        }

        #quest-reminder-popup .quest-popup-name {
            font-weight: bold;
            color: var(--text-color); /* Maintain theme text color */
            flex-grow: 1; /* Allow name to take available space */
            margin-right: 0.5rem;
        }

        /* Styles for the checkbox toggle */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 38px;
            height: 22px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 22px;
        }

        .dark-mode .toggle-slider {
            background-color: #555;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 2px;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
            background-color: white;
            bottom: 2px;
        }

        input:checked + .toggle-slider {
            background-color: var(--accent-color);
        }

        input:checked + .toggle-slider:before {
            -webkit-transform: translateX(16px);
            -ms-transform: translateX(16px);
            transform: translateX(16px);
        }

        .toggle-label {
            margin-left: 0.5rem;
            font-size: 0.9rem;
            opacity: 0.8;
            user-select: none;
        }

        /* NEW: Bond-specific Connection Meter Styles */
        .bond-connection-meter-container {
            margin-top: 0.75rem;
            padding-top: 0.5rem;
            border-top: 1px dashed var(--border-color);
            text-align: center;
        }

        .bond-connection-meter-label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 0.25rem;
            display: block;
        }

        .bond-connection-meter {
            width: 100%;
            height: 12px;
            -webkit-appearance: none;
            appearance: none;
            background: linear-gradient(to right, var(--connection-low-color) 0%, var(--connection-medium-color) 50%, var(--connection-high-color) 100%);
            border-radius: 6px;
            outline: none;
            transition: box-shadow 0.2s ease-in-out;
            margin-bottom: 0.5rem;
        }

        .bond-connection-meter::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--accent-color);
            border: 2px solid var(--border-strong-color);
            border-radius: 50%;
            cursor: grab;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
            transition: background-color 0.2s, border-color 0.2s;
        }
        .bond-connection-meter::-webkit-slider-thumb:active {
            cursor: grabbing;
        }

        .bond-connection-meter::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--accent-color);
            border: 2px solid var(--border-strong-color);
            border-radius: 50%;
            cursor: grab;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
            transition: background-color 0.2s, border-color 0.2s;
        }
        .bond-connection-meter::-moz-range-thumb:active {
            cursor: grabbing;
        }

        /* Remove default focus outline and apply custom focus style */
        .bond-connection-meter:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--glow-color), 0 0 0 5px var(--accent-color);
        }

        .bond-connection-label {
            font-size: 0.95rem;
            font-weight: bold;
            color: var(--text-color);
            display: block;
            margin-bottom: 0.5rem;
        }

        /* Color-coded labels based on connection level */
        .bond-connection-label.desprezo-total { color: var(--connection-low-color); }
        .dark-mode .bond-connection-label.desprezo-total { color: var(--connection-low-color); } /* Explicit for dark mode */

        .bond-connection-label.indiferenca { color: var(--text-color); opacity: 0.6; }
        .dark-mode .bond-connection-label.indiferenca { color: var(--text-color); opacity: 0.6; }

        .bond-connection-label.conexao-futil { color: var(--connection-medium-color); }
        .dark-mode .bond-connection-label.conexao-futil { color: var(--connection-medium-color); }

        .bond-connection-label.lacos-frageis { color: var(--connection-high-color); opacity: 0.7; }
        .dark-mode .bond-connection-label.lacos-frageis { color: var(--connection-high-color); opacity: 0.7; }

        .bond-connection-label.conexao-genuina { color: var(--connection-high-color); }
        .dark-mode .bond-connection-label.conexao-genuina { color: var(--connection-high-color); }

        /* Styles for the subtle audio player popup */
        #audio-player-popup {
            position: fixed;
            bottom: 4rem; /* Adjust based on preference */
            right: 1rem; /* Adjust based on preference */
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-strong-color);
            border-radius: 0.5rem;
            padding: 0.75rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            z-index: 90; /* Below modals, above toast */
            transform: translateX(120%); /* Hidden by default */
            transition: transform 0.3s ease-out;
        }

        #audio-player-popup.visible {
            transform: translateX(0);
        }

        #audio-player-popup h4 {
            font-family: 'IM Fell English SC', serif;
            font-size: 1.1rem;
            text-align: center;
            color: var(--accent-color);
        }

        #audio-player-popup .controls {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
        }

        #audio-player-popup button {
            background-color: var(--border-strong-color);
            color: var(--accent-text-color);
            border: none;
            border-radius: 0.25rem;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        #audio-player-popup button:hover {
            background-color: var(--accent-color);
            box-shadow: 0 0 5px 1px var(--glow-color);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="sheet-container" class="max-w-7xl mx-auto paper-bg rounded-lg p-4 md:p-6 parchment-container">
        <header class="grid grid-cols-1 md:grid-cols-3 gap-4 border-b-2 border-[var(--border-strong-color)] pb-4 mb-4">
            <div class="col-span-1 md:col-span-2 flex items-center">
                <label for="char-img-input" class="w-24 h-24 mr-4 rounded-full overflow-hidden border-2 border-[var(--border-strong-color)] flex-shrink-0 cursor-pointer"><img id="char-img-preview" src="https://placehold.co/100x100/c8a06e/4a2c2a?text=Icon" alt="Ícone do Personagem" class="w-full h-full object-cover"></label>
                <input type="file" id="char-img-input" class="hidden" accept="image/*">
                <div>
                    <input type="text" id="char-name" class="font-ornate text-4xl input-base w-full mb-1" placeholder="Nome do Personagem">
                    <div class="grid grid-cols-2 gap-x-4"><input type="text" id="char-race" class="input-base" placeholder="Raça"><input type="text" id="char-origin" class="input-base" placeholder="Origem/Classe"></div>
                </div>
            </div>
            <div class="col-span-1 flex flex-col items-end justify-between">
                <div class="flex items-center space-x-4">
                    <button id="wallpaper-btn" title="Mudar Papel de Parede" class="text-xl text-[var(--border-strong-color)] hover:text-[var(--accent-color)]"><i class="fas fa-image"></i></button>
                    <input type="file" id="wallpaper-input" class="hidden" accept="image/*">
                    <button id="theme-toggle" title="Alternar Modo" class="text-xl text-[var(--border-strong-color)] hover:text-[var(--accent-color)]"><i class="fas fa-moon"></i></button>
                    <button id="audio-toggle-btn" title="Controles de Áudio" class="text-xl text-[var(--border-strong-color)] hover:text-[var(--accent-color)]"><i class="fas fa-music"></i></button> <button id="settings-btn" title="Configurações da Ficha" class="text-xl text-[var(--border-strong-color)] hover:text-[var(--accent-color)]"><i class="fas fa-cog"></i></button>
                </div>
                <div class="flex items-center justify-around text-center w-full mt-2">
                    <div id="inspiration-tracker" class="text-center cursor-pointer p-2 rounded-lg border border-transparent hover:border-[var(--border-color)] transition-all">
                        <div class="font-ornate text-lg">Inspiração</div>
                        <i class="fas fa-lightbulb text-2xl opacity-30"></i>
                    </div>
                    <div>
                        <label for="char-level" class="font-ornate text-lg">Nível</label>
                        <div class="flex items-center justify-center"><span class="num-input-control" data-target="char-level" data-step="-1">‹</span><input type="number" id="char-level" class="input-base text-2xl w-12" value="1" min="1" max="20"><span class="num-input-control" data-target="char-level" data-step="1">›</span></div>
                    </div>
                    <div><div class="font-ornate text-lg">Proficiência</div><div id="proficiency-bonus" class="text-2xl font-bold">+2</div></div>
                </div>
            </div>
        </header>

        <div class="mb-4 flex justify-center space-x-2 md:space-x-4 border-b-2 border-[var(--border-color)] pb-2">
            <button class="tab-button active" onclick="openTab(event, 'main-stats')"><i class="fas fa-scroll"></i><span class="tab-text">Status</span></button>
            <button class="tab-button" onclick="openTab(event, 'character')"><i class="fas fa-user"></i><span class="tab-text">Personagem</span></button>
            <button class="tab-button" onclick="openTab(event, 'inventory')"><i class="fas fa-briefcase"></i><span class="tab-text">Inventário</span></button>
            <button class="tab-button" onclick="openTab(event, 'abilities')"><i class="fas fa-star"></i><span class="tab-text">Habilidades</span></button>
            <button class="tab-button" onclick="openTab(event, 'journal')"><i class="fas fa-book-open"></i><span class="tab-text">Diário</span></button>
            <button class="tab-button" onclick="openTab(event, 'bonds')"><i class="fas fa-users"></i><span class="tab-text">Vínculos</span></button>
            <button class="tab-button" onclick="openTab(event, 'weapons')"><i class="fas fa-fire"></i><span class="tab-text">Armas</span></button>
            <button class="tab-button" onclick="openTab(event, 'quests')"><i class="fas fa-map-marked-alt"></i><span class="tab-text">Missões</span></button>
        </div>

        <main>
            <div id="main-stats" class="tab-content active">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="space-y-6">
                        <div class="paper-bg p-4 rounded-lg">
                            <h2 class="font-ornate text-2xl text-center mb-4">Atributos</h2>
                            <div id="attributes-container" class="grid grid-cols-2 gap-4"></div>
                        </div>
                        <div class="paper-bg p-4 rounded-lg">
                            <h2 class="font-ornate text-2xl text-center mb-4">Salvaguardas</h2>
                            <div id="saving-throws-container" class="space-y-2"></div>
                        </div>
                    </div>
                    <div class="space-y-6">
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div class="paper-bg p-3 rounded-lg"><label class="font-ornate">Classe de Armadura</label><input type="number" id="ac" class="input-base text-3xl" value="10"></div>
                            <div class="paper-bg p-3 rounded-lg"><label class="font-ornate">Iniciativa</label><div id="initiative-bonus" class="text-3xl font-bold">+0</div></div>
                            <div class="paper-bg p-3 rounded-lg"><label class="font-ornate">Deslocamento</label><input type="text" id="speed" class="input-base text-3xl" value="30ft"></div>
                        </div>
                        <div class="paper-bg p-4 rounded-lg text-center">
                            <h2 class="font-ornate text-2xl mb-2">Pontos de Vida</h2>
                            <div class="flex items-center justify-center space-x-2"><input type="number" id="hp-current" placeholder="Atuais" class="input-base w-20 text-2xl"><span class="text-2xl">/</span><input type="number" id="hp-max" placeholder="Max" class="input-base w-20 text-2xl"></div>
                            <div class="hp-bar-container mt-3"><div id="hp-bar" class="hp-bar-fill"></div></div>
                        </div>
                        <div class="paper-bg p-4 rounded-lg">
                            <h2 class="font-ornate text-2xl text-center mb-4">Condições</h2>
                            <div id="conditions-container" class="flex flex-wrap justify-center gap-2 mt-2"></div>
                        </div>
                        <div class="paper-bg p-4 rounded-lg">
                            <h2 class="font-ornate text-2xl text-center mb-4">Testes Contra a Morte</h2>
                            <div class="flex justify-around"><div><h3 class="font-bold">Sucessos</h3><div id="death-saves-success" class="flex space-x-2 mt-2"><div class="death-save"></div><div class="death-save"></div><div class="death-save"></div></div></div><div><h3 class="font-bold">Falhas</h3><div id="death-saves-failure" class="flex space-x-2 mt-2"><div class="death-save"></div><div class="death-save"></div><div class="death-save"></div></div></div></div>
                        </div>
                    </div>
                    <div class="paper-bg p-4 rounded-lg">
                        <h2 class="font-ornate text-2xl text-center mb-4">Perícias</h2>
                        <div id="skills-container" class="space-y-2"></div>
                    </div>
                </div>
            </div>
            <div id="character" class="tab-content p-4">
                <h2 class="font-ornate text-3xl mb-4 text-center">Aparência e História</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div><label class="font-ornate text-xl">Traços de Personalidade</label><div id="editor-personality-traits" class="quill-editor-container h-24"></div></div>
                        <div><label class="font-ornate text-xl">Ideais</label><div id="editor-ideals" class="quill-editor-container h-24"></div></div>
                        <div><label class="font-ornate text-xl">Vínculos (Backstory)</label><div id="editor-bonds-backstory" class="quill-editor-container h-24"></div></div>
                        <div><label class="font-ornate text-xl">Defeitos</label><div id="editor-flaws" class="quill-editor-container h-24"></div></div>
                    </div>
                    <div>
                        <label class="font-ornate text-xl">História do Personagem</label>
                        <div id="editor-backstory" class="quill-editor-container min-h-[400px]"></div>
                    </div>
                </div>
            </div>
            <div id="inventory" class="tab-content p-4">
                <div class="paper-bg p-4 rounded-lg mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="font-ornate text-2xl text-center mb-4">Itens Equipados</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div id="equipped-slot-main-weapon" class="equipped-slot" data-slot="main-weapon">
                                    <span class="slot-label">Arma Principal</span>
                                    <span class="slot-name">Nenhum</span>
                                    <button class="clear-button hidden" data-clear-slot="main-weapon">Limpar</button>
                                </div>
                                <div id="equipped-slot-offhand" class="equipped-slot" data-slot="offhand">
                                    <span class="slot-label">Mão Secundária</span>
                                    <span class="slot-name">Nenhum</span>
                                    <button class="clear-button hidden" data-clear-slot="offhand">Limpar</button>
                                </div>
                                <div id="equipped-slot-armor" class="equipped-slot" data-slot="armor">
                                    <span class="slot-label">Armadura</span>
                                    <span class="slot-name">Nenhum</span>
                                    <button class="clear-button hidden" data-clear-slot="armor">Limpar</button>
                                </div>
                                <div id="equipped-slot-other" class="equipped-slot" data-slot="other">
                                    <span class="slot-label">Outro Item</span>
                                    <span class="slot-name">Nenhum</span>
                                    <button class="clear-button hidden" data-clear-slot="other">Limpar</button>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h3 class="font-ornate text-2xl text-center mb-4">Moedas</h3>
                            <div class="paper-bg p-3 rounded-lg">
                                <div class="coin-display">
                                    <div class="flex items-center">
                                        <i class="fas fa-coins text-yellow-600"></i>
                                        <label class="font-bold">Cobre (PC)</label>
                                    </div>
                                    <input type="number" id="coins-cp" class="input-base text-right" value="0">
                                </div>
                                <div class="coin-display">
                                    <div class="flex items-center">
                                        <i class="fas fa-coins text-gray-400"></i>
                                        <label class="font-bold">Prata (PP)</label>
                                    </div>
                                    <input type="number" id="coins-sp" class="input-base text-right" value="0">
                                </div>
                                <div class="coin-display">
                                    <div class="flex items-center">
                                        <i class="fas fa-coins text-yellow-500"></i>
                                        <label class="font-bold">Ouro (PO)</label>
                                    </div>
                                    <input type="number" id="coins-gp" class="input-base text-right" value="0">
                                </div>
                                <div class="coin-display">
                                    <div class="flex items-center">
                                        <i class="fas fa-coins text-blue-300"></i>
                                        <label class="font-bold">Platina (PL)</label>
                                    </div>
                                    <input type="number" id="coins-pp" class="input-base text-right" value="0">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <h2 class="font-ornate text-3xl mb-4">Mochila</h2>
                <button class="action-button font-bold py-2 px-4 rounded mb-4" onclick="openModal('item-modal')">Adicionar Item</button>
                <div id="inventory-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
            <div id="journal" class="tab-content p-4"><h2 class="font-ornate text-3xl mb-4">Diário</h2><button class="action-button font-bold py-2 px-4 rounded mb-4" onclick="openModal('journal-modal')">Adicionar Entrada</button><div id="journal-entries" class="space-y-4"></div></div>
            <div id="abilities" class="tab-content p-4">
                <h2 class="font-ornate text-3xl mb-4">Traços e Habilidades</h2>
                <button class="action-button font-bold py-2 px-4 rounded mb-4" onclick="openModal('ability-modal')">Adicionar Traço/Habilidade</button>

                <div class="mb-4 flex flex-wrap gap-2 items-center justify-between">
                    <div id="ability-filters" class="flex flex-wrap gap-2">
                        <button class="ability-filter-button active" data-filter="All">Todas</button>
                        <button class="ability-filter-button" data-filter="Racial">Racial</button>
                        <button class="ability-filter-button" data-filter="Classe">Classe</button>
                        <button class="ability-filter-button" data-filter="Feito">Feito</button>
                        <button class="ability-filter-button" data-filter="Magia">Magia</button>
                        <button class="ability-filter-button" data-filter="Equipamento">Equipamento</button>
                        <button class="ability-filter-button" data-filter="Geral">Geral</button>
                    </div>
                    <input type="text" id="ability-search" class="input-base flex-grow max-w-xs md:max-w-none text-left pl-2" placeholder="Buscar habilidade...">
                </div>

                <div id="abilities-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    </div>
            </div>
            <div id="bonds" class="tab-content p-4">
                <h2 class="font-ornate text-3xl mb-4">Vínculos Sociais</h2>
                <button class="action-button font-bold py-2 px-4 rounded mb-4" onclick="openModal('bond-modal')">Adicionar Vínculo</button>
                <div id="bonds-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
            
            <div id="weapons" class="tab-content p-4">
                <h2 class="font-ornate text-3xl mb-4">Armas e Ataques</h2>
                <button class="action-button font-bold py-2 px-4 rounded mb-4" onclick="openModal('weapon-modal')">Adicionar Arma</button>
                <div id="weapons-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    </div>
            </div>

            <div id="quests" class="tab-content p-4">
                <h2 class="font-ornate text-3xl mb-4">Missões</h2>
                <div class="flex justify-between items-center mb-4">
                    <button class="action-button font-bold py-2 px-4 rounded" onclick="openModal('quest-modal')">Adicionar Missão</button>
                    <div class="flex items-center">
                        <span class="toggle-label mr-2">Ativar Lembrete de Missões</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggle-quest-reminder">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                <div id="quests-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
        </main>
        
        <div class="paper-bg p-4 rounded-lg mt-6 text-center">
            <h2 class="font-ornate text-2xl mb-4">Rolador de Dados</h2>
            <div class="flex flex-wrap justify-center gap-2 mb-4">
                <button class="dice-button" onclick="rollDice(4)">D4</button>
                <button class="dice-button" onclick="rollDice(6)">D6</button>
                <button class="dice-button" onclick="rollDice(8)">D8</button>
                <button class="dice-button" onclick="rollDice(10)">D10</button>
                <button class="dice-button" onclick="rollDice(12)">D12</button>
                <button class="dice-button" onclick="rollDice(20)">D20</button>
            </div>
            <div id="dice-result" class="mt-2"></div>
        </div>
    </div>
    
    <div id="toast-container"></div>

    <input type="file" id="import-file-input" class="hidden" accept="application/json">

    <div id="item-modal" class="modal"><div class="modal-content"><span class="close-button" onclick="closeModal('item-modal')">&times;</span><h3 class="font-ornate text-2xl mb-4">Item</h3><input type="text" id="item-name" class="input-base w-full mb-2" placeholder="Nome do Item"><label for="item-img-input" class="block text-center cursor-pointer p-2 border border-dashed border-[var(--border-strong-color)] rounded-md my-2 hover:bg-[var(--tab-active-bg)]">Carregar Imagem</label><input type="file" id="item-img-input" class="hidden" accept="image/*"><img id="item-img-preview" class="hidden w-full h-32 object-cover rounded mb-2"><input type="text" id="item-rarity" class="input-base w-full mb-2" placeholder="Raridade (ex: Comum, Lendário)"><input type="text" id="item-type" class="input-base w-full mb-2" placeholder="Tipo (ex: Arma, Armadura)"><div id="editor-item-bonus" class="quill-editor-container h-24"></div><button id="save-item-btn" class="action-button font-bold py-2 px-4 rounded mt-4 w-full">Salvar Item</button></div></div>
    <div id="journal-modal" class="modal"><div class="modal-content"><span class="close-button" onclick="closeModal('journal-modal')">&times;</span><h3 class="font-ornate text-2xl mb-4">Entrada no Diário</h3><input type="text" id="journal-title" class="input-base w-full mb-2" placeholder="Título"><input type="date" id="journal-date" class="input-base w-full mb-2"><div id="editor-journal-content" class="quill-editor-container min-h-[160px]"></div><button id="save-journal-btn" class="action-button font-bold py-2 px-4 rounded mt-4 w-full">Salvar Entrada</button></div></div>
    <div id="ability-modal" class="modal"><div class="modal-content"><span class="close-button" onclick="closeModal('ability-modal')">&times;</span><h3 class="font-ornate text-2xl mb-4">Traço ou Habilidade</h3><input type="text" id="ability-name" class="input-base w-full mb-2" placeholder="Nome"><div id="editor-ability-desc" class="quill-editor-container h-24 mb-2"></div><div class="flex items-center space-x-2"><input type="number" id="ability-uses" class="input-base w-16" placeholder="Usos"><select id="ability-reset" class="input-base bg-[var(--bg-color)]"><option value="none">N/A</option><option value="short-rest">por Descanso Curto</option><option value="long-rest">por Descanso Longo</option></select></div>
    <label for="ability-category" class="block text-sm font-bold mt-4 mb-1">Categoria:</label>
    <select id="ability-category" class="input-base bg-[var(--bg-color)] w-full mb-4">
        <option value="Geral">Geral</option>
        <option value="Racial">Racial</option>
        <option value="Classe">Classe</option>
        <option value="Feito">Feito</option>
        <option value="Magia">Magia</option>
        <option value="Equipamento">Equipamento</option>
    </select>
    <button id="save-ability-btn" class="action-button font-bold py-2 px-4 rounded mt-4 w-full">Salvar</button></div></div>
    <div id="bond-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('bond-modal')">&times;</span>
            <h3 class="font-ornate text-2xl mb-4">Vínculo Social</h3>
            <input type="text" id="bond-name" class="input-base w-full mb-2" placeholder="Nome">
            <label for="bond-img-input" class="block text-center cursor-pointer p-2 border border-dashed border-[var(--border-strong-color)] rounded-md my-2 hover:bg-[var(--tab-active-bg)]">Carregar Imagem</label>
            <input type="file" id="bond-img-input" class="hidden" accept="image/*">
            <img id="bond-img-preview" class="hidden w-24 h-24 object-cover rounded-full mx-auto mb-2">
            <input type="text" id="bond-relationship" class="input-base w-full mb-2" placeholder="Relação (ex: Aliado, Rival)">
            <div id="editor-bond-summary" class="quill-editor-container h-24"></div>
            <div class="bond-connection-meter-container">
                <label for="bond-connection-meter" class="bond-connection-meter-label">Nível de Conexão Genuína:</label>
                <input type="range" id="bond-connection-meter" class="bond-connection-meter" min="0" max="100" value="100">
                <span id="bond-connection-value" class="bond-connection-label">100% - Conexão Genuína</span>
            </div>
            <button id="save-bond-btn" class="action-button font-bold py-2 px-4 rounded mt-4 w-full">Salvar Vínculo</button>
        </div>
    </div>
    
    <div id="weapon-modal" class="modal"><div class="modal-content"><span class="close-button" onclick="closeModal('weapon-modal')">&times;</span><h3 class="font-ornate text-2xl mb-4">Arma</h3><input type="text" id="weapon-name" class="input-base w-full mb-2" placeholder="Nome da Arma"><input type="text" id="weapon-damage" class="input-base w-full mb-2" placeholder="Dano (ex: 1d8 perfurante)"><input type="text" id="weapon-type" class="input-base w-full mb-2" placeholder="Tipo (ex: Simples, Corpo a Corpo)"><div id="editor-weapon-properties" class="quill-editor-container h-24 mb-2"></div><label for="weapon-attribute" class="block text-sm font-bold mb-1">Atributo de Ataque:</label><select id="weapon-attribute" class="input-base bg-[var(--bg-color)] w-full mb-4"><option value="STR">Força (STR)</option><option value="DEX">Destreza (DEX)</option></select><label for="weapon-img-input" class="block text-center cursor-pointer p-2 border border-dashed border-[var(--border-strong-color)] rounded-md my-2 hover:bg-[var(--tab-active-bg)]">Carregar Imagem</label><input type="file" id="weapon-img-input" class="hidden" accept="image/*"><img id="weapon-img-preview" class="hidden w-full h-32 object-cover rounded mb-2"><button id="save-weapon-btn" class="action-button font-bold py-2 px-4 rounded mt-4 w-full">Salvar Arma</button></div></div>

    <div id="journal-view-modal" class="modal"><div class="modal-content"><span class="close-button" onclick="closeModal('journal-view-modal')">&times;</span><div id="journal-view-content" class="max-h-[70vh] overflow-y-auto pr-4"></div><div class="text-right mt-4"><button id="edit-journal-from-view-btn" class="action-button font-bold py-2 px-6 rounded">Editar</button></div></div></div>
    
    <div id="confirm-delete-modal" class="modal"><div class="modal-content text-center"><h3 class="font-ornate text-2xl mb-4">Tem certeza?</h3><p class="mb-6">Esta ação não pode ser desfeita.</p><div class="flex justify-center space-x-4"><button id="cancel-delete-btn" class="font-bold py-2 px-6 rounded">Cancelar</button><button id="confirm-delete-btn" class="danger-button font-bold py-2 px-6 rounded">Excluir</button></div></div></div>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('settings-modal')">&times;</span>
            <h3 class="font-ornate text-2xl mb-4 text-center">Configurações da Ficha</h3>
            <div class="space-y-4">
                <button class="action-button font-bold py-2 px-4 rounded w-full" onclick="exportCharacterSheet()">Exportar Ficha (.json)</button>
                <label for="import-file-input" class="action-button font-bold py-2 px-4 rounded w-full text-center cursor-pointer">
                    Importar Ficha (.json)
                </label>
                <p class="text-sm opacity-80 text-center">Importar irá substituir todos os dados atuais da ficha.</p>
                <hr class="border-[var(--border-color)] my-4">
                <div class="space-y-2">
                    <h4 class="font-ornate text-xl">Configurações de Áudio</h4>
                    <label for="background-music-input" class="action-button font-bold py-2 px-4 rounded w-full text-center cursor-pointer">Carregar Música de Fundo</label>
                    <input type="file" id="background-music-input" class="hidden" accept="audio/*" multiple>
                    <div id="music-playlist" class="space-y-1"></div>
                    <div class="flex items-center gap-2">
                        <label for="music-volume" class="text-sm opacity-80">Volume Música:</label>
                        <input type="range" id="music-volume" min="0" max="100" value="50" class="w-full">
                    </div>
                    
                    <label for="sfx-input" class="action-button font-bold py-2 px-4 rounded w-full text-center cursor-pointer">Carregar Efeito Sonoro (SFX)</label>
                    <input type="file" id="sfx-input" class="hidden" accept="audio/*">
                    <div id="sfx-preview-container" class="flex justify-center items-center gap-2">
                        <span id="sfx-name" class="text-sm opacity-80">Nenhum SFX</span>
                        <button id="play-sfx-preview" class="action-button text-sm px-2 py-1 hidden">Play</button>
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="sfx-volume" class="text-sm opacity-80">Volume SFX:</label>
                        <input type="range" id="sfx-volume" min="0" max="100" value="50" class="w-full">
                    </div>
                     <div class="flex items-center gap-2 mt-2">
                        <label for="sfx-loop-toggle" class="text-sm opacity-80">Loop SFX:</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="sfx-loop-toggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                <hr class="border-[var(--border-color)] my-4">
                <button class="danger-button font-bold py-2 px-4 rounded w-full" onclick="resetCharacterSheetConfirm()">Redefinir Ficha (Limpar Tudo)</button>
                <p class="text-sm opacity-80 text-center text-red-700">Esta ação não pode ser desfeita!</p>
            </div>
        </div>
    </div>

    <div id="ability-view-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('ability-view-modal')">&times;</span>
            <div class="modal-header">
                <h3 id="ability-view-title" class="modal-title"></h3>
                <p id="ability-view-category" class="modal-category"></p>
            </div>
            <div id="ability-view-full-desc" class="modal-body">
                </div>
            <div class="flex justify-between items-center mt-4">
                <div id="ability-view-uses-info" class="text-sm opacity-80"></div>
                <button id="edit-ability-from-view-btn" class="action-button font-bold py-2 px-6 rounded">Editar</button>
            </div>
        </div>
    </div>

    <div id="select-item-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('select-item-modal')">&times;</span>
            <h3 class="font-ornate text-2xl mb-4">Selecionar Item/Arma</h3>
            <input type="text" id="select-item-search" class="input-base w-full mb-4 pl-2 text-left" placeholder="Buscar item/arma...">
            <div class="flex gap-2 mb-4">
                <button class="action-button py-1 px-3 rounded text-sm select-item-filter active" data-filter-type="all">Todos</button>
                <button class="action-button py-1 px-3 rounded text-sm select-item-filter" data-filter-type="item">Itens</button>
                <button class="action-button py-1 px-3 rounded text-sm select-item-filter" data-filter-type="weapon">Armas</button>
            </div>
            <div id="item-select-list" class="item-select-list">
                </div>
        </div>
    </div>

    <div id="quest-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('quest-modal')">&times;</span>
            <h3 class="font-ornate text-2xl mb-4">Missão</h3>
            <input type="text" id="quest-title" class="input-base w-full mb-2" placeholder="Título da Missão">
            <div id="editor-quest-description" class="quill-editor-container min-h-[160px] mb-2"></div>
            <label for="quest-status" class="block text-sm font-bold mt-4 mb-1">Status:</label>
            <select id="quest-status" class="input-base bg-[var(--bg-color)] w-full mb-4">
                <option value="open">Aberta</option>
                <option value="completed">Concluída</option>
                <option value="cancelled">Cancelada</option>
            </select>
            <label for="quest-priority" class="block text-sm font-bold mt-2 mb-1">Prioridade:</label>
            <select id="quest-priority" class="input-base bg-[var(--bg-color)] w-full mb-4">
                <option value="low">Baixa</option>
                <option value="medium">Média</option>
                <option value="high">Alta</option>
                <option value="urgent">Urgente</option>
            </select>
            <button id="save-quest-btn" class="action-button font-bold py-2 px-4 rounded mt-4 w-full">Salvar Missão</button>
        </div>
    </div>

    <div id="quest-view-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('quest-view-modal')">&times;</span>
            <div class="modal-header">
                <h3 id="quest-view-title" class="modal-title"></h3>
                <p id="quest-view-status" class="quest-card-status"></p>
                <p id="quest-view-priority" class="quest-priority-tag"></p>
            </div>
            <div id="quest-view-full-description" class="modal-body"></div>
            <div class="text-right mt-4">
                <button id="edit-quest-from-view-btn" class="action-button font-bold py-2 px-6 rounded">Editar</button>
            </div>
        </div>
    </div>

    <div id="quest-reminder-popup" class="fixed bottom-4 right-4 z-100 hidden">
        <h3>Missões Pendentes</h3>
        <ul id="quest-reminder-list">
        </ul>
        </div>

    <div id="audio-player-popup" class="hidden">
        <h4 id="current-track-name">Nenhuma Música</h4>
        <div class="controls">
            <button id="prev-track-btn" title="Faixa Anterior"><i class="fas fa-backward"></i></button>
            <button id="play-pause-btn" title="Reproduzir/Pausar"><i class="fas fa-play"></i></button>
            <button id="next-track-btn" title="Próxima Faixa"><i class="fas fa-forward"></i></button>
        </div>
    </div>

<script>
    const STORAGE_KEY = 'dnd-character-sheet-data';

    const dataStore = {
        attributes: [ { name: 'Força', short: 'STR' }, { name: 'Destreza', short: 'DEX' }, { name: 'Constituição', short: 'CON' }, { name: 'Inteligência', short: 'INT' }, { name: 'Sabedoria', short: 'WIS' }, { name: 'Carisma', short: 'CHA' } ],
        skills: [ { name: 'Acrobacia', attr: 'DEX' }, { name: 'Lidar com Animais', attr: 'WIS' }, { name: 'Arcanismo', attr: 'INT' }, { name: 'Atletismo', attr: 'STR' }, { name: 'Enganação', attr: 'CHA' }, { name: 'História', attr: 'INT' }, { name: 'Intuição', attr: 'WIS' }, { name: 'Intimidação', attr: 'CHA' }, { name: 'Investigação', attr: 'INT' }, { name: 'Medicina', attr: 'WIS' }, { name: 'Natureza', attr: 'INT' }, { name: 'Percepção', attr: 'WIS' }, { name: 'Atuação', attr: 'CHA' }, { name: 'Persuasão', attr: 'CHA' }, { name: 'Religião', attr: 'INT' }, { name: 'Prestidigitação', attr: 'DEX' }, { name: 'Furtividade', attr: 'DEX' }, { name: 'Sobrevivência', attr: 'WIS' } ],
        conditions: [ 
            { name: 'Agarrado', icon: 'fas fa-hand-fist' },
            { name: 'Amedrontado', icon: 'fas fa-face-grimace' },
            { name: 'Atordoado', icon: 'fas fa-dizzy' },
            { name: 'Caído', icon: 'fas fa-person-falling' },
            { name: 'Cego', icon: 'fas fa-eye-slash' },
            { name: 'Enfeitiçado', icon: 'fas fa-heart' },
            { name: 'Envenenado', icon: 'fas fa-skull-crossbones' },
            { name: 'Exaustão', icon: 'fas fa-tired' },
            { name: 'Incapacitado', icon: 'fas fa-bed' },
            { name: 'Inconsciente', icon: 'fas fa-moon' },
            { name: 'Invisível', icon: 'fas fa-eye-low-vision' },
            { name: 'Paralisado', icon: 'fas fa-ban' },
            { name: 'Petrificado', icon: 'fas fa-gem' },
            { name: 'Surdo', icon: 'fas fa-volume-xmark' }
        ],
        characterSheetData: {
            staticInputs: {
                "char-name": "", "char-race": "", "char-origin": "",
                "char-level": "1", "ac": "10", "speed": "30ft",
                "hp-current": "0", "hp-max": "1",
                "coins-cp": "0", "coins-sp": "0", "coins-gp": "0", "coins-pp": "0",
                "personality-traits": "", "ideals": "", "bonds-backstory": "", "flaws": "", "backstory": "",
                "journal-title": "", "journal-date": "", "journal-content": "",
                "ability-name": "", "ability-desc": "", "ability-uses": "", "ability-reset": "none", "ability-category": "Geral",
                "bond-name": "", "bond-relationship": "", "bond-summary": "",
                "weapon-name": "", "weapon-damage": "", "weapon-type": "", "weapon-properties": "", "weapon-attribute": "STR",
                "questReminderEnabled": true // Toggle for quest reminder popup
            },
            equippedItems: {
                "main-weapon": null,
                "offhand": null,
                "armor": null,
                "other": null
            },
            toggles: {},
            dynamic: {
                item: [],
                journal: [],
                ability: [
                    // Habilidades do Swashbuckler (nova versão)
                    {
                        name: "Audácia Descarada",
                        desc: "Ao rolar Iniciativa, você pode adicionar seu modificador de Carisma à rolagem. Além disso, você pode usar seu Ataque Furtivo contra uma criatura se estiver a 1,5m dela, nenhuma outra criatura estiver a 1,5m de você, e você não tiver Desvantagem na jogada de ataque.",
                        uses: "",
                        reset: "none",
                        category: "Subclasse (Swashbuckler)",
                        level: 3,
                        id: "swashbuckler-rakish-audacity"
                    },
                    {
                        name: "Passos Gracioso",
                        desc: "Se você fizer um ataque corpo a corpo contra uma criatura durante seu turno, essa criatura não pode fazer Ataques de Oportunidade contra você pelo resto daquele turno.",
                        uses: "",
                        reset: "none",
                        category: "Subclasse (Swashbuckler)",
                        level: 3,
                        id: "swashbuckler-fancy-footwork"
                    },
                    {
                        name: "Panache",
                        desc: "Você aprendeu novas formas de usar seu Ataque Furtivo. Os seguintes efeitos estão agora entre suas opções de Golpe Astuto:<br><b>Provocar (Custo: 1d6):</b> O alvo deve passar em um teste de resistência de Sabedoria, ou até o final do próximo turno dele, o alvo tem Desvantagem em jogadas de ataque contra alvos que não sejam você e não pode fazer Ataques de Oportunidade contra alvos que não sejam você.<br><b>Admirar (Custo: 3d6):</b> Cada criatura à sua escolha dentro de 9m de você deve passar em um teste de resistência de Sabedoria ou ficará com a condição Enfeitiçada até o final do seu próximo turno.",
                        uses: "Variável (custo em d6 de Sneak Attack)",
                        reset: "none",
                        category: "Subclasse (Swashbuckler)",
                        level: 9,
                        id: "swashbuckler-panache"
                    },
                    {
                        name: "Golpes Descarados (Dashing Strikes)",
                        desc: "Você aprendeu novas formas de usar seu Ataque Furtivo. Os seguintes efeitos estão agora entre suas opções de Golpe Astuto:<br><b>Postura de Aparar (Custo: 2d6):</b> Role um d6. Até o início do seu próximo turno, você ganha um bônus na sua CA igual ao número rolado.<br><b>Revigorar (Custo: 2d6):</b> Escolha uma criatura que você possa ver a até 9m de você. Até o final do próximo turno dessa criatura, sempre que ela fizer uma jogada de ataque ou um teste de resistência, ela pode rolar um d6 e adicionar o número rolado à jogada de ataque ou ao teste de resistência.",
                        uses: "Variável (custo em d6 de Sneak Attack)",
                        reset: "none",
                        category: "Subclasse (Swashbuckler)",
                        level: 13,
                        id: "swashbuckler-dashing-strikes"
                    },
                    {
                        name: "Mestre Duelista (Master Duelist)",
                        desc: "Imediatamente após usar seu Ataque Furtivo, você pode fazer outro ataque contra o mesmo alvo, desde que esteja a 1,5m dele e nenhuma outra criatura esteja a 1,5m de você.",
                        uses: "1 por rodada",
                        reset: "round", // Assumindo "uma vez por rodada" como um reset por rodada de combate
                        category: "Subclasse (Swashbuckler)",
                        level: 17,
                        id: "swashbuckler-master-duelist"
                    }
                ],
                bond: [], // Each bond will now store its own 'connection' value
                weapon: [],
                quest: [] // Array for quests
            },
            images: {
                charImage: "https://placehold.co/100x100/c8a06e/4a2c2a?text=Icon",
                wallpaper: "url('https://www.transparenttextures.com/patterns/old-wall.png')",
            },
            theme: 'light',
            // NEW: Audio data storage
            audio: {
                musicPlaylist: [],
                currentTrackIndex: 0,
                musicVolume: 50,
                sfxSource: null,
                sfxVolume: 50,
                sfxLoop: false
            }
        }
    };
    let elementToDelete = null;
    let lastHpValue = 0;
    let currentAbilityFilter = 'All'; // Starts showing all
    let currentEquipSlot = null; // To track which slot is being edited

    // Quill instances for rich text editors
    let quillEditors = {};

    // NEW: Audio objects
    const backgroundMusicAudio = new Audio();
    const sfxAudio = new Audio();
    let isPlayingMusic = false;
    let isPlayingSfx = false;

    document.addEventListener('DOMContentLoaded', () => {
        populateAttributes();
        populateSavingThrows();
        populateSkills();
        populateConditions();
        setupQuillEditors(); // Initialize Quill editors
        setupEventListeners();
        loadFromLocalStorage(); 
        applyThemeFromData();
        document.querySelectorAll('.tab-button.active').forEach(b => b.classList.add('glow-effect'));
        updateEquippedItemsUI(); // Update equipped items on load

        // Show quest reminder popup on page load, if enabled
        showQuestReminderPopup();
        setupAudioPlayer(); // NEW: Setup audio player on load
    });

    // --- Functions for Quill.js ---
    function setupQuillEditors() {
        const toolbarOptions = [
            ['bold', 'italic', 'underline', 'strike'],        // toggled buttons
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            [{ 'align': [] }],
            ['clean']                                         // remove formatting button
        ];

        // Character tab editors
        quillEditors['personality-traits'] = new Quill('#editor-personality-traits', {
            modules: { toolbar: toolbarOptions },
            theme: 'snow',
            placeholder: 'Traços de personalidade...'
        });
        quillEditors['ideals'] = new Quill('#editor-ideals', {
            modules: { toolbar: toolbarOptions },
            theme: 'snow',
            placeholder: 'Ideais...'
        });
        quillEditors['bonds-backstory'] = new Quill('#editor-bonds-backstory', {
            modules: { toolbar: toolbarOptions },
            theme: 'snow',
            placeholder: 'Vínculos (Backstory)...'
        });
        quillEditors['flaws'] = new Quill('#editor-flaws', {
            modules: { toolbar: toolbarOptions },
            theme: 'snow',
            placeholder: 'Defeitos...'
        });
        quillEditors['backstory'] = new Quill('#editor-backstory', {
            modules: { toolbar: toolbarOptions },
            theme: 'snow',
            placeholder: 'História do Personagem...'
        });

        // Item modal editor
        quillEditors['item-bonus'] = new Quill('#editor-item-bonus', {
            modules: { toolbar: toolbarOptions },
            theme: 'snow',
            placeholder: 'Descrição e Bônus...'
        });

        // Journal modal editor
        quillEditors['journal-content'] = new Quill('#editor-journal-content', {
            modules: { toolbar: toolbarOptions },
            theme: 'snow',
            placeholder: 'Escreva sua entrada...'
        });

        // Ability modal editor
        quillEditors['ability-desc'] = new Quill('#editor-ability-desc', {
            modules: { toolbar: toolbarOptions },
            theme: 'snow',
            placeholder: 'Descrição da habilidade...'
        });

        // Bond modal editor
        quillEditors['bond-summary'] = new Quill('#editor-bond-summary', {
            modules: { toolbar: toolbarOptions },
            theme: 'snow',
            placeholder: 'Resumo da Relação...'
        });

        // Weapon modal editor
        quillEditors['weapon-properties'] = new Quill('#editor-weapon-properties', {
            modules: { toolbar: toolbarOptions },
            theme: 'snow',
            placeholder: 'Propriedades (ex: Acuidade, Leve)...'
        });

        // NEW: Quest modal editor
        quillEditors['quest-description'] = new Quill('#editor-quest-description', {
            modules: { toolbar: toolbarOptions },
            theme: 'snow',
            placeholder: 'Descreva a missão...'
        });

        // Add event listeners to Quill editors to save data
        for (const editorId in quillEditors) {
            quillEditors[editorId].on('text-change', debounce(() => {
                const htmlContent = quillEditors[editorId].root.innerHTML;
                const targetId = editorId.replace('editor-', ''); // Get original ID (e.g., personality-traits)
                dataStore.characterSheetData.staticInputs[targetId] = htmlContent;
                saveToLocalStorage();
            }, 500));
        }
    }

    function setQuillEditorContent(editorId, content) {
        if (quillEditors[editorId]) {
            quillEditors[editorId].root.innerHTML = content;
        }
    }

    function getQuillEditorContent(editorId) {
        if (quillEditors[editorId]) {
            return quillEditors[editorId].root.innerHTML;
        }
        return '';
    }

    // --- End Functions for Quill.js ---


    // --- Funções de Cálculo e Atualização Globais ---
    function getProficiencyBonus() { return Math.floor(((parseInt(document.getElementById('char-level').value) || 1) - 1) / 4) + 2; }
    function getAttributeModifier(attrShort) { return Math.floor(((parseInt(document.getElementById(`attr-${attrShort}`).value) || 10) - 10) / 2); }

    function updateAllCalculations() {
        const profBonus = getProficiencyBonus();
        document.getElementById('proficiency-bonus').textContent = `+${profBonus}`;
        dataStore.attributes.forEach(attr => {
            const modEl = document.getElementById(`mod-${attr.short}`);
            const oldMod = modEl.textContent;
            const newModVal = getAttributeModifier(attr.short); 
            const newModText = newModVal >= 0 ? `+${newModVal}` : newModVal;
            
            if (oldMod !== newModText) {
                modEl.textContent = newModText;
                modEl.classList.add('modifier-flash');
                modEl.addEventListener('animationend', () => modEl.classList.remove('modifier-flash'), { once: true });
            }
        });
        // NEW: Calculate Initiative as DEX Mod + CHA Mod for Swashbuckler
        const dexMod = getAttributeModifier('DEX');
        const chaMod = getAttributeModifier('CHA'); // Get Charisma Modifier
        const initiativeBonus = dexMod + chaMod;
        document.getElementById('initiative-bonus').textContent = initiativeBonus >= 0 ? `+${initiativeBonus}` : initiativeBonus;

        dataStore.attributes.forEach(attr => {
            const modifier = getAttributeModifier(attr.short);
            const profToggle = document.querySelector(`.proficiency-toggle[data-type="save"][data-name="${attr.short}"]`);
            let totalBonus = modifier;
            if (profToggle) {
                if (profToggle.classList.contains('proficient')) totalBonus += profBonus;
                else if (profToggle.classList.contains('expertise')) totalBonus += (profBonus * 2);
            }
            document.getElementById(`save-bonus-${attr.short}`).textContent = totalBonus >= 0 ? `+${totalBonus}` : totalBonus;
        });
        dataStore.skills.forEach(skill => {
            const modifier = getAttributeModifier(skill.attr);
            const profToggle = document.querySelector(`.proficiency-toggle[data-type="skill"][data-name="${skill.name}"]`);
            let totalBonus = modifier;
            if (profToggle) {
                if (profToggle.classList.contains('proficient')) totalBonus += profBonus;
                else if (profToggle.classList.contains('expertise')) totalBonus += (profBonus * 2);
            }
            document.getElementById(`skill-bonus-${skill.name.replace(/\s+/g, '')}`).textContent = totalBonus >= 0 ? `+${totalBonus}` : totalBonus;
        });
        updateHpBar();
    }

    function updateHpBar() {
        const currentHp = parseInt(document.getElementById('hp-current').value) || 0;
        const maxHp = parseInt(document.getElementById('hp-max').value) || 1;
        const hpPercentage = Math.max(0, Math.min(100, (currentHp / maxHp) * 100));
        
        const hpBar = document.getElementById('hp-bar');
        hpBar.style.width = `${hpPercentage}%`;

        // Cores de barra de HP baseadas nos novos temas
        if (hpPercentage > 50) { 
            hpBar.style.backgroundColor = document.documentElement.classList.contains('dark-mode') ? '#60c790' : '#2b7a4b'; 
        }
        else if (hpPercentage > 25) { 
            hpBar.style.backgroundColor = document.documentElement.classList.contains('dark-mode') ? '#e06c75' : '#d4a778'; 
        }
        else { 
            hpBar.style.backgroundColor = document.documentElement.classList.contains('dark-mode') ? '#e06c75' : '#b33939'; 
        }
    }
    // --- Fim das Funções de Cálculo e Atualização Globais ---


    function populateAttributes() {
        const container = document.getElementById('attributes-container');
        container.innerHTML = '';
        dataStore.attributes.forEach(attr => {
            container.innerHTML += `<div class="text-center paper-bg p-2 rounded-lg"><label for="attr-${attr.short}" class="font-ornate text-xl">${attr.name}</label><div class="flex items-center justify-center"><span class="num-input-control" data-target="attr-${attr.short}" data-step="-1">‹</span><input type="number" id="attr-${attr.short}" class="input-base text-3xl font-bold attribute-score w-16" value="10" data-attr="${attr.short}"><span class="num-input-control" data-target="attr-${attr.short}" data-step="1">›</span></div><div id="mod-${attr.short}" class="text-lg border-t border-[var(--border-color)] mt-1">+0</div></div>`;
        });
    }
    function populateSavingThrows() {
        const container = document.getElementById('saving-throws-container');
        container.innerHTML = '';
        dataStore.attributes.forEach(attr => {
            container.innerHTML += `<div class="flex items-center justify-between"><div class="flex items-center space-x-2"><span class="advantage-toggle" title="Vantagem">V</span><span class="proficiency-toggle" data-type="save" data-name="${attr.short}" title="Proficiência/Especialização"></span><span>${attr.name}</span></div><div id="save-bonus-${attr.short}" class="font-bold">+0</div></div>`;
        });
    }
    function populateSkills() {
        const container = document.getElementById('skills-container');
        container.innerHTML = '';
        // Changed from space-y-1 to space-y-2 in HTML for more spacing
        dataStore.skills.forEach(skill => {
            container.innerHTML += `<div class="flex items-center justify-between text-sm"><div class="flex items-center space-x-2"><span class="advantage-toggle" title="Vantagem">V</span><span class="proficiency-toggle" data-type="skill" data-name="${skill.name}" title="Proficiência/Especialização"></span><span>${skill.name} <span class="text-xs opacity-70">(${skill.attr})</span></span></div><div id="skill-bonus-${skill.name.replace(/\s+/g, '')}" class="font-bold">+0</div></div>`;
        });
    }
    function populateConditions() {
        const container = document.getElementById('conditions-container');
        container.innerHTML = '';
        dataStore.conditions.forEach(condition => {
            container.innerHTML += `<div class="condition-token" title="${condition.name}"><i class="${condition.icon}"></i></div>`;
        });
    }

    // Definindo handleGlobalClick no escopo global
    function handleGlobalClick(e) {
        const target = e.target;
        const debouncedSave = debounce(saveToLocalStorage, 500);

        const control = target.closest('.num-input-control');
        const deleteBtn = target.closest('.delete-btn');
        const editBtn = target.closest('.edit-btn');
        const journalCard = target.closest('.journal-card');
        const abilityUseTick = target.closest('.ability-use-tick');
        const conditionToken = target.closest('.condition-token');
        const inspirationTracker = target.closest('#inspiration-tracker');
        const attackButton = target.closest('.attack-button');
        const damageButton = target.closest('.damage-button');
        const abilityCard = target.closest('.dynamic-card[data-type="ability"]');
        const proficiencyToggle = target.closest('.proficiency-toggle');
        const advantageToggle = target.closest('.advantage-toggle');
        const equippedSlot = target.closest('.equipped-slot');
        const clearEquipButton = target.closest('.clear-button[data-clear-slot]');

        const questCard = target.closest('.quest-card');
        const questToggleStatusBtn = target.closest('.toggle-status-btn');

        if (deleteBtn) {
            elementToDelete = deleteBtn.closest('.dynamic-card') || deleteBtn.closest('.quest-card');
            openModal('confirm-delete-modal');
            return;
        }
        if (editBtn) {
            const card = editBtn.closest('.dynamic-card');
            const type = card.dataset.type;
            const id = card.id;
            if (type === 'weapon') {
                editWeapon(id);
            } else if (type === 'ability') {
                editAbility(id);
            } else if (type === 'quest') {
                editQuest(id);
            } else if (type === 'bond') { // Edit Bond also uses its modal
                editBond(id);
            }
             else {
                window[`edit${capitalize(type)}`](id);
            }
            return;
        }
        if (attackButton) {
            const weaponId = attackButton.closest('.dynamic-card').id;
            rollAttack(weaponId);
            return;
        }
        if (damageButton) {
            const weaponId = damageButton.closest('.dynamic-card').id;
            rollDamageForWeapon(weaponId);
            return;
        }

        if (control) {
            const targetId = control.dataset.target;
            const step = parseInt(control.dataset.step);
            const input = document.getElementById(targetId);
            if (input) {
                input.value = parseInt(input.value) + step;
                input.dispatchEvent(new Event('input', { bubbles: true }));
                vibrate(20);
            }
        }
        if (proficiencyToggle) {
            toggleProficiency(proficiencyToggle);
            vibrate(30);
            debouncedSave();
        }
        if (advantageToggle) {
            advantageToggle.classList.toggle('active');
            vibrate(30);
            debouncedSave();
        }
        if (target.classList.contains('death-save')) {
            target.classList.toggle('filled');
            vibrate(30);
            debouncedSave();
        }
        if (journalCard) {
            viewJournalEntry(journalCard.id);
        }
        if (abilityUseTick) {
            abilityUseTick.classList.toggle('used');
            vibrate(50);
            debouncedSave();
        }
        if (conditionToken || target.closest('.condition-token')) {
            const actualToken = conditionToken || target.closest('.condition-token');
            actualToken.classList.toggle('active');
            vibrate(30);
            debouncedSave();
        }
        if (inspirationTracker) {
            inspirationTracker.classList.toggle('active');
            vibrate(40);
            debouncedSave();
        }

        if (abilityCard && 
            !target.closest('.edit-btn') && 
            !target.closest('.delete-btn') && 
            !target.closest('.ability-use-tick') &&
            !target.closest('.ability-filter-button'))
        {
            viewAbilityDetails(abilityCard.id);
        }

        if (equippedSlot) {
            currentEquipSlot = equippedSlot.dataset.slot;
            openSelectItemModal();
        }

        if (clearEquipButton) {
            const slotToClear = clearEquipButton.dataset.clearSlot;
            clearEquippedSlot(slotToClear);
            debouncedSave();
        }

        if (questCard && !target.closest('.quest-actions')) {
            viewQuestDetails(questCard.id);
        }
        if (questToggleStatusBtn) {
            const questId = questToggleStatusBtn.closest('.quest-card').id;
            toggleQuestStatus(questId);
            debouncedSave();
        }
    }


    function setupEventListeners() {
        const debouncedSave = debounce(saveToLocalStorage, 500);
        const sheetContainer = document.getElementById('sheet-container');
        
        // Listen for input changes on static elements
        document.querySelectorAll('input[id], select[id]').forEach(el => {
            if (el.type !== 'file' && !el.id.startsWith('editor-')) {
                el.addEventListener('input', handleStatChange);
                el.addEventListener('input', debouncedSave);
            }
        });
        
        // Global click listener for toggles and dynamic elements
        sheetContainer.addEventListener('click', handleGlobalClick);
        
        document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
        document.getElementById('wallpaper-btn').addEventListener('click', () => document.getElementById('wallpaper-input').click());
        
        document.getElementById('wallpaper-input').addEventListener('change', handleFileSelect(e => {
            document.body.style.backgroundImage = `url('${e.target.result}')`;
            dataStore.characterSheetData.images.wallpaper = `url('${e.target.result}')`;
            debouncedSave();
        }));

        document.getElementById('char-img-input').addEventListener('change', handleFileSelect(e => {
            document.getElementById('char-img-preview').src = e.target.result;
            dataStore.characterSheetData.images.charImage = e.target.result;
            debouncedSave();
        }));

        document.getElementById('item-img-input').addEventListener('change', handleFileSelect(e => {
            const preview = document.getElementById('item-img-preview');
            preview.src = e.target.result;
            preview.classList.remove('hidden');
        }));
        document.getElementById('bond-img-input').addEventListener('change', handleFileSelect(e => {
            const preview = document.getElementById('bond-img-preview');
            preview.src = e.target.result;
            preview.classList.remove('hidden');
        }));
        // Weapon Image Input Listener
        document.getElementById('weapon-img-input').addEventListener('change', handleFileSelect(e => {
            const preview = document.getElementById('weapon-img-preview');
            preview.src = e.target.result;
            preview.classList.remove('hidden');
        }));


        document.getElementById('save-item-btn').addEventListener('click', () => { saveData('item'); debouncedSave(); });
        document.getElementById('save-journal-btn').addEventListener('click', () => { saveData('journal'); debouncedSave(); });
        document.getElementById('save-ability-btn').addEventListener('click', () => { saveData('ability'); debouncedSave(); });
        document.getElementById('save-bond-btn').addEventListener('click', () => { saveData('bond'); debouncedSave(); });
        document.getElementById('save-weapon-btn').addEventListener('click', () => { saveData('weapon'); debouncedSave(); });
        // Save Quest button
        document.getElementById('save-quest-btn').addEventListener('click', () => { saveData('quest'); debouncedSave(); });
        
        document.getElementById('cancel-delete-btn').addEventListener('click', () => closeModal('confirm-delete-modal'));
        document.getElementById('confirm-delete-btn').addEventListener('click', () => {
            if (elementToDelete) {
                elementToDelete.remove();
                const type = elementToDelete.dataset.type || 
                             (elementToDelete.classList.contains('journal-card') ? 'journal' :
                             elementToDelete.classList.contains('quest-card') ? 'quest' : null);

                if (type && dataStore.characterSheetData.dynamic[type]) {
                    const id = elementToDelete.id;
                    dataStore.characterSheetData.dynamic[type] = dataStore.characterSheetData.dynamic[type].filter(item => item.id !== id);

                    for (const slot in dataStore.characterSheetData.equippedItems) {
                        if (dataStore.characterSheetData.equippedItems[slot] && dataStore.characterSheetData.equippedItems[slot].id === id) {
                            dataStore.characterSheetData.equippedItems[slot] = null;
                            updateEquippedItemsUI();
                            break;
                        }
                    }
                    showToast('Excluído com sucesso.', 'success');
                } else {
                    console.error('Tipo de elemento ou array dinâmico não encontrado para exclusão:', elementToDelete);
                    showToast('Erro ao excluir. Tipo de elemento desconhecido.', 'error');
                }
                elementToDelete = null;
                debouncedSave();
            }
            closeModal('confirm-delete-modal');
        });

        document.getElementById('edit-journal-from-view-btn').addEventListener('click', (e) => {
            const id = e.target.dataset.editingId;
            if (id) {
                closeModal('journal-view-modal');
                editJournal(id);
            }
        });
        // New listener for the ability edit button in the view modal
        document.getElementById('edit-ability-from-view-btn').addEventListener('click', (e) => {
            const id = e.target.dataset.editingId;
            if (id) {
                closeModal('ability-view-modal');
                editAbility(id);
            }
        });
        // Listener for the quest edit button in the view modal
        document.getElementById('edit-quest-from-view-btn').addEventListener('click', (e) => {
            const id = e.target.dataset.editingId;
            if (id) {
                closeModal('quest-view-modal');
                editQuest(id);
            }
        });


        document.querySelectorAll('.dice-button').forEach(button => {
            button.addEventListener('click', (e) => {
                const diceType = parseInt(e.target.textContent.replace('D', ''));
                rollDice(diceType);
            });
        });

        // Event listeners for new ability filters and search
        document.getElementById('ability-filters').addEventListener('click', (e) => {
            if (e.target.classList.contains('ability-filter-button')) {
                document.querySelectorAll('.ability-filter-button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                currentAbilityFilter = e.target.dataset.filter;
                renderDynamicList('ability', dataStore.characterSheetData.dynamic.ability);
                debouncedSave();
            }
        });

        document.getElementById('ability-search').addEventListener('input', debounce(() => {
            renderDynamicList('ability', dataStore.characterSheetData.dynamic.ability);
            debouncedSave();
        }, 300));

        // Sheet settings
        document.getElementById('settings-btn').addEventListener('click', () => openModal('settings-modal'));
        document.getElementById('import-file-input').addEventListener('change', importCharacterSheet);

        // Item Select Modal Listeners
        document.getElementById('select-item-search').addEventListener('input', debounce(() => {
            populateSelectItemModal();
        }, 300));

        document.querySelectorAll('.select-item-filter').forEach(button => {
            button.addEventListener('click', (e) => {
                document.querySelectorAll('.select-item-filter').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                populateSelectItemModal(e.target.dataset.filterType);
            });
        });

        document.getElementById('item-select-list').addEventListener('click', (e) => {
            const selectedCard = e.target.closest('.item-select-card');
            if (selectedCard) {
                const type = selectedCard.dataset.type;
                const id = selectedCard.dataset.id;
                equipItemToSlot(currentEquipSlot, type, id);
                closeModal('select-item-modal');
                debouncedSave();
            }
        });

        // Toggle Quest Reminder
        document.getElementById('toggle-quest-reminder').addEventListener('change', (e) => {
            dataStore.characterSheetData.staticInputs.questReminderEnabled = e.target.checked;
            saveToLocalStorage();
            if (!e.target.checked) {
                document.getElementById('quest-reminder-popup').classList.add('hidden');
            } else {
                showQuestReminderPopup();
            }
        });

        // NEW: Bond Connection Meter listener in modal
        const bondConnectionMeterInput = document.getElementById('bond-connection-meter');
        if (bondConnectionMeterInput) { // Ensure element exists before adding listener
            bondConnectionMeterInput.addEventListener('input', (e) => {
                const value = parseInt(e.target.value);
                updateBondConnectionMeterUIInModal(value);
            });
        }

        // NEW: Audio Control Listeners
        document.getElementById('audio-toggle-btn').addEventListener('click', toggleAudioPlayerPopup);

        document.getElementById('background-music-input').addEventListener('change', handleMusicFileSelect);
        document.getElementById('music-volume').addEventListener('input', (e) => {
            dataStore.characterSheetData.audio.musicVolume = e.target.value;
            backgroundMusicAudio.volume = e.target.value / 100;
            saveToLocalStorage();
        });
        document.getElementById('sfx-input').addEventListener('change', handleSfxFileSelect);
        document.getElementById('sfx-loop-toggle').addEventListener('change', (e) => {
            dataStore.characterSheetData.audio.sfxLoop = e.target.checked;
            sfxAudio.loop = e.target.checked;
            if(isPlayingSfx && !e.target.checked) { sfxAudio.pause(); isPlayingSfx = false; }
            saveToLocalStorage();
        });
        document.getElementById('sfx-volume').addEventListener('input', (e) => {
            dataStore.characterSheetData.audio.sfxVolume = e.target.value;
            sfxAudio.volume = e.target.value / 100;
            saveToLocalStorage();
        });
        document.getElementById('play-sfx-preview').addEventListener('click', () => {
            if (sfxAudio.src) {
                if (sfxAudio.paused) {
                    sfxAudio.play().then(() => isPlayingSfx = true).catch(e => console.error("Error playing SFX:", e));
                } else {
                    sfxAudio.pause();
                    isPlayingSfx = false;
                }
            }
        });

        document.getElementById('play-pause-btn').addEventListener('click', toggleMusicPlayPause);
        document.getElementById('next-track-btn').addEventListener('click', playNextTrack);
        document.getElementById('prev-track-btn').addEventListener('click', playPrevTrack);
        backgroundMusicAudio.addEventListener('ended', playNextTrack);
    }
    
    function handleStatChange(e) {
        if (e.target.classList.contains('attribute-score') || e.target.id === 'char-level') {
            updateAllCalculations();
        }
        if (e.target.id === 'hp-current' || e.target.id === 'hp-max') {
            const currentHpEl = document.getElementById('hp-current');
            const newHpValue = parseInt(currentHpEl.value) || 0;
            if (newHpValue < lastHpValue) {
                vibrate([100, 30, 100]);
            }
            lastHpValue = newHpValue;
            updateHpBar();
        }
    }

    function toggleProficiency(element) {
        if (element.classList.contains('proficient')) { 
            element.classList.remove('proficient'); 
            element.classList.add('expertise'); 
            element.textContent = 'E'; 
        } else if (element.classList.contains('expertise')) { 
            element.classList.remove('expertise'); 
            element.textContent = ''; 
        } else { 
            element.classList.add('proficient'); 
            element.textContent = 'P'; 
        }
        updateAllCalculations();
    }

    function capitalize(s) { return s && s[0].toUpperCase() + s.slice(1); }
    function openTab(evt, tabName) {
        document.querySelectorAll(".tab-button").forEach(btn => btn.classList.remove("active", "glow-effect"));
        document.querySelectorAll(".tab-content").forEach(tab => tab.style.display = "none");
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.classList.add("active", "glow-effect");

        if (tabName === 'abilities') {
            document.querySelectorAll('.ability-filter-button').forEach(btn => {
                if (btn.dataset.filter === currentAbilityFilter) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            renderDynamicList('ability', dataStore.characterSheetData.dynamic.ability);
        } else if (tabName === 'quests') {
            renderDynamicList('quest', dataStore.characterSheetData.dynamic.quest);
            document.getElementById('quest-reminder-popup').classList.add('hidden');
        }
    }
    function openModal(modalId, editingId = null) {
        const modal = document.getElementById(modalId);
        modal.dataset.editingId = editingId || '';
        if (modalId !== 'confirm-delete-modal' && modalId !== 'journal-view-modal' && modalId !== 'settings-modal' && modalId !== 'ability-view-modal' && modalId !== 'select-item-modal' && modalId !== 'quest-view-modal') {
            modal.querySelectorAll('input[type="text"], input[type="number"], input[type="date"], select').forEach(el => {
                el.value = '';
            });
            for (const editorId in quillEditors) {
                if (modal.querySelector(`#editor-${editorId}`)) {
                    quillEditors[editorId].setContents([]);
                }
            }
            
            if (modalId === 'ability-modal') {
                document.getElementById('ability-category').value = 'Geral';
            }
            if (modalId === 'quest-modal') {
                document.getElementById('quest-status').value = 'open';
                document.getElementById('quest-priority').value = 'medium';
            }
            // Set default for bond connection meter when opening new bond modal
            if (modalId === 'bond-modal') {
                document.getElementById('bond-connection-meter').value = 100; // Default to 100%
                updateBondConnectionMeterUIInModal(100); // Update the displayed value/label
            }

            const previews = modal.querySelectorAll('img[id$="-preview"]');
            previews.forEach(p => { p.classList.add('hidden'); p.removeAttribute('src'); });
        }
        modal.style.display = 'block';
    }
    function closeModal(modalId) { 
        document.getElementById(modalId).style.display = 'none'; 
    }
    window.onclick = (event) => { 
        if (event.target.classList.contains('modal')) event.target.style.display = "none";
        // Close audio player popup if clicked outside
        const audioPlayerPopup = document.getElementById('audio-player-popup');
        const audioToggleButton = document.getElementById('audio-toggle-btn');
        if (audioPlayerPopup.classList.contains('visible') && 
            !audioPlayerPopup.contains(event.target) && 
            !audioToggleButton.contains(event.target)) {
            toggleAudioPlayerPopup();
        }
    }

    function toggleTheme() {
        const themeIcon = document.querySelector('#theme-toggle i');
        document.documentElement.classList.toggle('dark-mode');
        updateHpBar(); 
        
        // Re-apply connection meter colors on bond cards after theme change
        dataStore.characterSheetData.dynamic.bond.forEach(bond => {
            const bondCard = document.getElementById(bond.id);
            if (bondCard) {
                const connectionLabelSpan = bondCard.querySelector('.bond-connection-label');
                if (connectionLabelSpan) {
                     const connectionValue = bond.connection || 0;
                     const labelText = getBondConnectionLabel(connectionValue);
                     connectionLabelSpan.className = 'bond-connection-label'; // Reset classes
                     connectionLabelSpan.classList.add(labelText.toLowerCase().replace(/\s+/g, '-'));
                }
            }
        });

        // Update Quill editor theme
        for (const editorId in quillEditors) {
            const editorContainer = quillEditors[editorId].container;
            if (document.documentElement.classList.contains('dark-mode')) {
                editorContainer.classList.add('dark-mode');
            } else {
                editorContainer.classList.remove('dark-mode');
            }
        }


        if (document.documentElement.classList.contains('dark-mode')) { 
            themeIcon.classList.replace('fa-moon', 'fa-sun'); 
            dataStore.characterSheetData.theme = 'dark';
        } else { 
            themeIcon.classList.replace('fa-sun', 'fa-moon'); 
            dataStore.characterSheetData.theme = 'light';
        }
        saveToLocalStorage();
    }

    function applyThemeFromData() {
        const themeIcon = document.querySelector('#theme-toggle i');
        if (dataStore.characterSheetData.theme === 'dark') {
            document.documentElement.classList.add('dark-mode');
            themeIcon.classList.replace('fa-moon', 'fa-sun');
        } else {
            document.documentElement.classList.remove('dark-mode');
            themeIcon.classList.replace('fa-sun', 'fa-moon');
        }
        // Apply character image and wallpaper
        document.getElementById('char-img-preview').src = dataStore.characterSheetData.images.charImage || "https://placehold.co/100x100/c8a06e/4a2c2a?text=Icon";
        document.body.style.backgroundImage = dataStore.characterSheetData.images.wallpaper || "url('https://www.transparenttextures.com/patterns/old-wall.png')";

        // Apply theme to Quill editors on load
        for (const editorId in quillEditors) {
            const editorContainer = quillEditors[editorId].container;
            if (dataStore.characterSheetData.theme === 'dark') {
                editorContainer.classList.add('dark-mode');
            } else {
                editorContainer.classList.remove('dark-mode');
            }
        }
    }

    function handleFileSelect(callback) {
        return (event) => {
            const file = event.target.files[0];
            if (file) { 
                const reader = new FileReader(); 
                reader.onload = callback; 
                reader.readAsDataURL(file); 
            }
        };
    }
    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }
    
    function vibrate(duration) {
        if ('vibrate' in navigator) {
            navigator.vibrate(duration);
        }
    }
    
    function extractCardData(cardElement) {
        const data = {};
        for (const key in cardElement.dataset) {
            data[key] = cardElement.dataset[key];
        }
        return data;
    }

    function saveData(type) {
        const modalId = `${type}-modal`;
        const modal = document.getElementById(modalId);
        const editingId = modal.dataset.editingId;
        const data = {};
        let isValid = true;

        switch (type) {
            case 'item':
                data.name = document.getElementById('item-name').value;
                data.type = document.getElementById('item-type').value;
                data.bonus = getQuillEditorContent('item-bonus'); // Get content from Quill
                data.rarity = document.getElementById('item-rarity').value;
                data.img = document.getElementById('item-img-preview').src; 
                data.id = editingId || crypto.randomUUID();
                if (!data.name || !data.type || data.bonus.trim() === '<p><br></p>') { // Check for empty Quill content
                    isValid = false;
                    showToast('Nome, tipo e descrição são obrigatórios.', 'error');
                }
                break;
            case 'journal':
                data.title = document.getElementById('journal-title').value;
                data.date = document.getElementById('journal-date').value;
                data.content = getQuillEditorContent('journal-content'); // Get content from Quill
                data.id = editingId || crypto.randomUUID();
                if (!data.title || !data.date || data.content.trim() === '<p><br></p>') { // Check for empty Quill content
                    isValid = false;
                    showToast('Título, data e conteúdo são obrigatórios.', 'error');
                }
                break;
            case 'ability':
                data.name = document.getElementById('ability-name').value;
                data.desc = getQuillEditorContent('ability-desc'); // Get content from Quill
                data.uses = document.getElementById('ability-uses').value;
                data.reset = document.getElementById('ability-reset').value;
                data.category = document.getElementById('ability-category').value;
                data.id = editingId || crypto.randomUUID();
                if (editingId) {
                    const existingAbility = dataStore.characterSheetData.dynamic.ability.find(a => a.id === editingId);
                    if (existingAbility) {
                        data.usedStates = existingAbility.usedStates || [];
                    }
                } else {
                    data.usedStates = [];
                }
                if (!data.name || data.desc.trim() === '<p><br></p>' || !data.category) { // Check for empty Quill content
                    isValid = false;
                    showToast('Nome, descrição e categoria são obrigatórios.', 'error');
                }
                break;
            case 'bond':
                data.name = document.getElementById('bond-name').value;
                data.relationship = document.getElementById('bond-relationship').value;
                data.summary = getQuillEditorContent('bond-summary'); // Get content from Quill
                data.img = document.getElementById('bond-img-preview').src;
                data.id = editingId || crypto.randomUUID();
                data.connection = document.getElementById('bond-connection-meter').value; // NEW: Save connection value
                if (!data.name || !data.relationship) {
                    isValid = false;
                    showToast('Nome e relação são obrigatórios.', 'error');
                }
                break;
            case 'weapon':
                data.name = document.getElementById('weapon-name').value;
                data.damage = document.getElementById('weapon-damage').value;
                data.type = document.getElementById('weapon-type').value;
                data.properties = getQuillEditorContent('weapon-properties'); // Get content from Quill
                data.attribute = document.getElementById('weapon-attribute').value;
                data.img = document.getElementById('weapon-img-preview').src; // NEW: Save weapon image
                data.id = editingId || crypto.randomUUID();
                if (!data.name || !data.damage) {
                    isValid = false;
                    showToast('Nome e dano da arma são obrigatórios.', 'error');
                }
                break;
            case 'quest': // NEW: Quest data handling
                data.title = document.getElementById('quest-title').value;
                data.description = getQuillEditorContent('quest-description');
                data.status = document.getElementById('quest-status').value;
                data.priority = document.getElementById('quest-priority').value; // NEW: Save priority
                data.id = editingId || crypto.randomUUID();
                if (!data.title || data.description.trim() === '<p><br></p>') {
                    isValid = false;
                    showToast('Título e descrição da missão são obrigatórios.', 'error');
                }
                break;
        }

        if (!isValid) return;

        let dynamicDataArray = dataStore.characterSheetData.dynamic[type];

        if (editingId) {
            const index = dynamicDataArray.findIndex(entry => entry.id === editingId);
            if (index !== -1) {
                dynamicDataArray[index] = data;
            }
        } else {
            dynamicDataArray.push(data);
        }
        
        renderDynamicList(type, dynamicDataArray);
        closeModal(modalId);
        showToast(`${capitalize(type)} salvo com sucesso!`, 'success');
        if (type === 'quest') {
            showQuestReminderPopup(); // Re-evaluate and show popup after saving a quest
        }
    }

    function renderDynamicList(type, dataArray) {
        const listIdMap = {
            item: 'inventory-list',
            journal: 'journal-entries',
            ability: 'abilities-list',
            bond: 'bonds-list',
            weapon: 'weapons-list',
            quest: 'quests-list'
        };
        const listElement = document.getElementById(listIdMap[type]);
        if (!listElement) {
            console.error(`Elemento com ID '${listIdMap[type]}' não encontrado.`);
            return;
        }
        listElement.innerHTML = '';

        const charLevel = parseInt(document.getElementById('char-level').value) || 1; // Get current character level

        if (type === 'ability') {
            const searchTerm = document.getElementById('ability-search').value.toLowerCase();

            const filteredAbilities = dataArray.filter(ability => {
                const matchesCategory = currentAbilityFilter === 'All' || ability.category === currentAbilityFilter;
                const matchesSearch = ability.name.toLowerCase().includes(searchTerm) || ability.desc.toLowerCase().includes(searchTerm);
                
                // Only show abilities if character level meets requirement
                const meetsLevelRequirement = !ability.level || charLevel >= ability.level;

                return matchesCategory && matchesSearch && meetsLevelRequirement;
            });

            if (filteredAbilities.length === 0) {
                listElement.innerHTML = '<p class="text-center opacity-70 col-span-full">Nenhuma habilidade encontrada para o filtro atual.</p>';
                return;
            }

            filteredAbilities.forEach(data => {
                const cardHTML = createCardHTML(type, data, data.id);
                listElement.insertAdjacentHTML('beforeend', cardHTML);
            });
        } else if (type === 'quest') {
            const priorityOrder = { 'urgent': 1, 'high': 2, 'medium': 3, 'low': 4 };
            const sortedQuests = [...dataArray].sort((a, b) => {
                if (a.status === 'open' && b.status !== 'open') return -1;
                if (a.status !== 'open' && b.status === 'open') return 1;

                if (a.status === 'open' && b.status === 'open') {
                    const priorityDiff = priorityOrder[a.priority] - priorityOrder[b.priority];
                    if (priorityDiff !== 0) return priorityDiff;
                }

                return a.title.localeCompare(b.title);
            });

            if (sortedQuests.length === 0) {
                listElement.innerHTML = '<p class="text-center opacity-70 col-span-full">Nenhuma missão adicionada ainda. Clique em "Adicionar Missão" para começar!</p>';
            } else {
                sortedQuests.forEach(data => {
                    const cardHTML = createCardHTML(type, data, data.id);
                    listElement.insertAdjacentHTML('beforeend', cardHTML);
                });
            }
        }
        else {
            dataArray.forEach(data => {
                const cardHTML = createCardHTML(type, data, data.id);
                listElement.insertAdjacentHTML('beforeend', cardHTML);
            });
        }
    }

    function viewAbilityDetails(id) {
        const abilityData = dataStore.characterSheetData.dynamic.ability.find(ability => ability.id === id);
        if (!abilityData) return;

        document.getElementById('ability-view-title').textContent = abilityData.name;
        document.getElementById('ability-view-category').textContent = abilityData.category;
        document.getElementById('ability-view-full-desc').innerHTML = abilityData.desc;
        
        const usesInfoElement = document.getElementById('ability-view-uses-info');
        if (abilityData.uses && abilityData.reset !== 'none') { 
            let usedCount = (abilityData.usedStates || []).filter(state => state).length;
            usesInfoElement.textContent = `Usos: ${usedCount}/${abilityData.uses} por ${abilityData.reset.replace('-', ' ')}`;
        } else {
            usesInfoElement.textContent = '';
        }

        document.getElementById('edit-ability-from-view-btn').dataset.editingId = id;

        openModal('ability-view-modal');
    }

    function editQuest(id) {
        const questData = dataStore.characterSheetData.dynamic.quest.find(quest => quest.id === id);
        if (!questData) return;

        openModal('quest-modal', id);
        document.getElementById('quest-title').value = questData.title;
        setQuillEditorContent('quest-description', questData.description);
        document.getElementById('quest-status').value = questData.status;
        document.getElementById('quest-priority').value = questData.priority || 'medium';
    }

    function viewQuestDetails(id) {
        const questData = dataStore.characterSheetData.dynamic.quest.find(quest => quest.id === id);
        if (!questData) return;

        document.getElementById('quest-view-title').textContent = questData.title;
        const statusElement = document.getElementById('quest-view-status');
        statusElement.textContent = capitalize(questData.status);
        statusElement.className = `quest-card-status ${questData.status}`;
        
        const priorityElement = document.getElementById('quest-view-priority');
        priorityElement.textContent = capitalize(questData.priority);
        priorityElement.className = `quest-priority-tag ${questData.priority}`;

        document.getElementById('quest-view-full-description').innerHTML = questData.description;

        document.getElementById('edit-quest-from-view-btn').dataset.editingId = id;
        openModal('quest-view-modal');
    }

    function toggleQuestStatus(id) {
        const questIndex = dataStore.characterSheetData.dynamic.quest.findIndex(q => q.id === id);
        if (questIndex !== -1) {
            const currentStatus = dataStore.characterSheetData.dynamic.quest[questIndex].status;
            if (currentStatus === 'open') {
                dataStore.characterSheetData.dynamic.quest[questIndex].status = 'completed';
                showToast('Missão marcada como Concluída!', 'success');
            } else if (currentStatus === 'completed') {
                dataStore.characterSheetData.dynamic.quest[questIndex].status = 'open';
                showToast('Missão reaberta!', 'success');
            } else {
                showToast('Missões canceladas só podem ser reabertas editando-as.', 'error');
                return; 
            }
            renderDynamicList('quest', dataStore.characterSheetData.dynamic.quest);
            showQuestReminderPopup();
        }
    }

    function showQuestReminderPopup() {
        const popup = document.getElementById('quest-reminder-popup');
        const questList = document.getElementById('quest-reminder-list');
        const quests = dataStore.characterSheetData.dynamic.quest;
        const reminderEnabled = dataStore.characterSheetData.staticInputs.questReminderEnabled;
        const priorityOrder = { 'urgent': 1, 'high': 2, 'medium': 3, 'low': 4 };


        questList.innerHTML = '';

        if (!reminderEnabled) {
            popup.classList.add('hidden');
            return;
        }

        const openQuests = quests
            .filter(q => q.status === 'open')
            .sort((a, b) => {
                const priorityDiff = priorityOrder[a.priority] - priorityOrder[b.priority];
                if (priorityDiff !== 0) return priorityDiff;
                return a.title.localeCompare(b.title);
            });

        if (openQuests.length > 0) {
            openQuests.forEach(quest => {
                const li = document.createElement('li');
                li.innerHTML = `<span class="quest-popup-name">${quest.title}</span><span class="quest-priority-tag ${quest.priority}">${capitalize(quest.priority)}</span>`;
                questList.appendChild(li);
            });
            popup.classList.remove('hidden');
        } else {
            popup.classList.add('hidden');
        }
    }

    function editItem(id) {
        const itemData = dataStore.characterSheetData.dynamic.item.find(item => item.id === id);
        if (!itemData) return;

        openModal('item-modal', id);
        document.getElementById('item-name').value = itemData.name;
        document.getElementById('item-rarity').value = itemData.rarity;
        document.getElementById('item-type').value = itemData.type;
        setQuillEditorContent('item-bonus', itemData.bonus);
        const preview = document.getElementById('item-img-preview');
        if (itemData.img && itemData.img.startsWith('data:image')) { preview.src = itemData.img; preview.classList.remove('hidden'); }
        else { preview.src = ""; preview.classList.add('hidden'); }
    }
    function editJournal(id) {
        const journalData = dataStore.characterSheetData.dynamic.journal.find(entry => entry.id === id);
        if (!journalData) return;

        openModal('journal-modal', id);
        document.getElementById('journal-title').value = journalData.title;
        document.getElementById('journal-date').value = journalData.date;
        setQuillEditorContent('journal-content', journalData.content);
    }
    function editAbility(id) {
        const abilityData = dataStore.characterSheetData.dynamic.ability.find(ability => ability.id === id);
        if (!abilityData) return;

        openModal('ability-modal', id);
        document.getElementById('ability-name').value = abilityData.name;
        setQuillEditorContent('ability-desc', abilityData.desc);
        document.getElementById('ability-uses').value = abilityData.uses;
        document.getElementById('ability-reset').value = abilityData.reset;
        document.getElementById('ability-category').value = abilityData.category || 'Geral';
    }
    function editBond(id) {
        const bondData = dataStore.characterSheetData.dynamic.bond.find(bond => bond.id === id);
        if (!bondData) return;

        openModal('bond-modal', id);
        document.getElementById('bond-name').value = bondData.name;
        document.getElementById('bond-relationship').value = bondData.relationship;
        setQuillEditorContent('bond-summary', bondData.summary);
        const preview = document.getElementById('bond-img-preview');
        if (bondData.img && bondData.img.startsWith('data:image')) { preview.src = bondData.img; preview.classList.remove('hidden'); }
        else { preview.src = ""; preview.classList.add('hidden'); }
        
        // Load connection meter value and update UI
        const bondConnectionMeter = document.getElementById('bond-connection-meter');
        if (bondConnectionMeter) {
            bondConnectionMeter.value = bondData.connection !== undefined ? bondData.connection : 100; // Default to 100 if not set
            updateBondConnectionMeterUIInModal(bondConnectionMeter.value); // Update the displayed value/label
        }
    }
    function editWeapon(id) {
        const weaponData = dataStore.characterSheetData.dynamic.weapon.find(weapon => weapon.id === id);
        if (!weaponData) return;

        openModal('weapon-modal', id);
        document.getElementById('weapon-name').value = weaponData.name;
        document.getElementById('weapon-damage').value = weaponData.damage;
        document.getElementById('weapon-type').value = weaponData.type;
        setQuillEditorContent('weapon-properties', weaponData.properties);
        document.getElementById('weapon-attribute').value = weaponData.attribute;
        const preview = document.getElementById('weapon-img-preview');
        if (weaponData.img && weaponData.img.startsWith('data:image')) { preview.src = weaponData.img; preview.classList.remove('hidden'); }
        else { preview.src = ""; preview.classList.add('hidden'); }
    }
    
    function viewJournalEntry(id) {
        const journalData = dataStore.characterSheetData.dynamic.journal.find(entry => entry.id === id);
        if (!journalData) return;

        const contentDiv = document.getElementById('journal-view-content');
        contentDiv.innerHTML = `
            <div class="flex justify-between items-baseline border-b border-[var(--border-color)] pb-2 mb-4">
                <h3 class="font-ornate text-3xl">${journalData.title}</h3>
                <p class="text-sm">${journalData.date}</p>
            </div>
            <div class="prose max-w-none text-lg">${journalData.content}</div> `;
        document.getElementById('edit-journal-from-view-btn').dataset.editingId = id;
        openModal('journal-view-modal');
    }

    function getBondConnectionLabel(value) {
        if (value >= 81) return "Conexão Genuína";
        if (value >= 61) return "Laços Frágeis";
        if (value >= 41) return "Conexão Fútil";
        if (value >= 21) return "Indiferença";
        return "Desprezo Total";
    }

    // Update function for the connection meter in the bond modal
    function updateBondConnectionMeterUIInModal(value) {
        const valueSpan = document.getElementById('bond-connection-value');
        const meter = document.getElementById('bond-connection-meter');
        if (valueSpan && meter) {
            valueSpan.textContent = `${value}% - ${getBondConnectionLabel(value)}`;
            valueSpan.className = 'bond-connection-label'; // Reset class
            valueSpan.classList.add(getBondConnectionLabel(value).toLowerCase().replace(/\s+/g, '-'));

            // Dynamically update the gradient background of the slider
            const colorLow = getComputedStyle(document.documentElement).getPropertyValue('--connection-low-color').trim();
            const colorMedium = getComputedStyle(document.documentElement).getPropertyValue('--connection-medium-color').trim();
            const colorHigh = getComputedStyle(document.documentElement).getPropertyValue('--connection-high-color').trim();
            const colorZero = getComputedStyle(document.documentElement).getPropertyValue('--connection-zero-color').trim();

            if (value === 0) {
                 meter.style.background = `${colorZero}`;
            } else {
                meter.style.background = `linear-gradient(to right, ${colorLow} 0%, ${colorLow} ${Math.min(value, 40)}%, ${colorMedium} ${Math.min(value, 60)}%, ${colorHigh} ${value}%, ${colorHigh} 100%)`;
            }
        }
    }


    function createCardHTML(type, data, id = null) {
        const cardId = id || crypto.randomUUID();
        const dataAttributes = Object.entries(data)
            .filter(([key, value]) => key !== 'usedStates')
            .map(([key, value]) => `data-${key}="${String(value || '').replace(/"/g, '&quot;')}"`)
            .join(' ');

        const actionsHTML = `<div class="absolute top-2 right-2 flex space-x-1 opacity-25 hover:opacity-100 transition-opacity"><button class="edit-btn text-sm p-1"><i class="fas fa-pencil-alt"></i></button><button class="delete-btn text-sm p-1"><i class="fas fa-trash-alt"></i></button></div>`;
        
        switch (type) {
            case 'item':
                return `<div id="${cardId}" class="dynamic-card paper-bg p-3 rounded-lg relative" data-type="item" ${dataAttributes}><img src="${data.img && data.img.startsWith('data:image') ? data.img : 'https://placehold.co/300x200/d4a778/5a403a?text=Item'}" alt="${data.name}" class="w-full h-32 object-cover rounded mb-2"><h4 class="font-ornate text-xl">${data.name}</h4><p class="text-sm italic">${data.rarity} ${data.type}</p><div class="text-sm mt-1 prose-sm">${data.bonus}</div>${actionsHTML}</div>`;
            case 'journal':
                return `<div id="${cardId}" class="dynamic-card journal-card paper-bg p-4 rounded-lg relative cursor-pointer" data-type="journal" ${dataAttributes}><div class="flex justify-between items-baseline pointer-events-none"><h4 class="font-ornate text-xl">${data.title}</h4><p class="text-sm">${data.date}</p></div><div class="text-sm italic opacity-70 ability-card-description prose-sm">${data.content}</div>${actionsHTML}</div>`;
            case 'ability':
                let usesHTML = '';
                if (data.uses && data.reset !== 'none') { 
                    const usedStates = data.usedStates || [];
                    const ticks = Array.from({length: parseInt(data.uses)}, (_, i) => 
                        `<div class="ability-use-tick w-4 h-4 border border-gray-400 rounded-sm cursor-pointer ${usedStates[i] ? 'used' : ''}"></div>`
                    ).join('');
                    usesHTML = `<div class="mt-2"><p class="text-sm">Usos: ${data.uses} por ${data.reset.replace('-', ' ')}</p><div class="flex space-x-1 mt-1">${ticks}</div></div>`; 
                }
                return `<div id="${cardId}" class="dynamic-card paper-bg p-4 rounded-lg relative cursor-pointer" data-type="ability" ${dataAttributes}>
                            <h4 class="font-ornate text-xl">${data.name} <span class="text-sm opacity-60">(${data.category})</span></h4>
                            <div class="text-sm mt-1 ability-card-description prose-sm">${data.desc}</div>
                            ${usesHTML}
                            ${actionsHTML}
                        </div>`;
            case 'bond':
                const connectionLabel = getBondConnectionLabel(data.connection || 0);
                return `<div id="${cardId}" class="dynamic-card paper-bg p-3 rounded-lg flex items-start space-x-4 relative" data-type="bond" ${dataAttributes}>
                            <img src="${data.img && data.img.startsWith('data:image') ? data.img : 'https://placehold.co/100x100/d4a778/5a403a?text=NPC'}" alt="${data.name}" class="w-24 h-24 object-cover rounded-full border-2 border-[var(--border-strong-color)]">
                            <div>
                                <h4 class="font-ornate text-2xl">${data.name}</h4>
                                <p class="text-md italic">${data.relationship}</p>
                                <div class="text-sm mt-2 prose-sm">${data.summary}</div>
                                <div class="bond-connection-meter-container">
                                    <span class="bond-connection-meter-label">Conexão: ${data.connection || 0}%</span>
                                    <span class="bond-connection-label ${connectionLabel.toLowerCase().replace(/\s+/g, '-')}">${connectionLabel}</span>
                                </div>
                            </div>
                            ${actionsHTML}
                        </div>`;
            case 'weapon':
                return `
                    <div id="${cardId}" class="dynamic-card paper-bg p-3 rounded-lg relative" data-type="weapon" ${dataAttributes}>
                        <h4 class="font-ornate text-xl">${data.name}</h4>
                        <p class="text-sm">Tipo: ${data.type}</p>
                        ${data.img && data.img.startsWith('data:image') ? `<img src="${data.img}" alt="${data.name}" class="w-full h-24 object-cover rounded mb-2">` : ''}
                        ${data.properties && data.properties.trim() !== '<p><br></p>' ? `<div class="text-sm prose-sm">Propriedades: ${data.properties}</div>` : ''}
                        <p class="text-sm">Atributo: ${data.attribute}</p>
                        <div class="flex justify-between mt-2">
                            <button class="action-button py-1 px-3 rounded text-sm attack-button">Atacar</button>
                            <button class="action-button py-1 px-3 rounded text-sm damage-button">Dano: ${data.damage}</button>
                        </div>
                        ${actionsHTML}
                    </div>
                `;
            case 'quest': // NEW: Quest card HTML
                let statusText = '';
                let toggleButtonText = '';
                if (data.status === 'open') {
                    statusText = 'Aberta';
                    toggleButtonText = '<i class="fas fa-check-circle"></i>';
                } else if (data.status === 'completed') {
                    statusText = 'Concluída';
                    toggleButtonText = '<i class="fas fa-redo"></i>';
                } else { // cancelled
                    statusText = 'Cancelada';
                    toggleButtonText = '';
                }
                const toggleButton = toggleButtonText ? `<button class="toggle-status-btn text-sm p-1" title="Marcar/Reabrir">${toggleButtonText}</button>` : '';

                return `
                    <div id="${cardId}" class="quest-card dynamic-card" data-type="quest" ${dataAttributes}>
                        <div class="quest-actions">
                            ${toggleButton}
                            <button class="edit-btn text-sm p-1" title="Editar Missão"><i class="fas fa-pencil-alt"></i></button>
                            <button class="delete-btn text-sm p-1" title="Excluir Missão"><i class="fas fa-trash-alt"></i></button>
                        </div>
                        <h4 class="font-ornate">${data.title} <span class="quest-priority-tag ${data.priority}">${capitalize(data.priority)}</span></h4>
                        <span class="quest-card-status ${data.status}">${statusText}</span>
                        <div class="text-sm mt-1 quest-card-description prose-sm">${data.description}</div>
                    </div>
                `;
        }
    }

    // --- Functions for Local Storage ---
    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

    function saveToLocalStorage() {
        document.querySelectorAll('input[id], select[id]').forEach(el => {
            if (el.type !== 'file' && !el.closest('.quill-editor-container')) {
                dataStore.characterSheetData.staticInputs[el.id] = el.value;
            }
        });
        
        document.querySelectorAll('.proficiency-toggle, .advantage-toggle, .death-save, .condition-token, #inspiration-tracker').forEach((el) => {
            let key = el.id || el.dataset.name || el.title;
            if (el.classList.contains('death-save')) {
                key = el.parentElement.id + '-' + Array.from(el.parentElement.children).indexOf(el);
                dataStore.characterSheetData.toggles[key] = el.classList.contains('filled');
            } else if (el.classList.contains('proficiency-toggle')) {
                if (el.classList.contains('proficient')) dataStore.characterSheetData.toggles[key] = 'proficient';
                else if (el.classList.contains('expertise')) dataStore.characterSheetData.toggles[key] = 'expertise';
                else dataStore.characterSheetData.toggles[key] = '';
            } else if (el.classList.contains('advantage-toggle') || el.classList.contains('condition-token') || el.id === 'inspiration-tracker') {
                dataStore.characterSheetData.toggles[key] = el.classList.contains('active');
            }
        });

        dataStore.characterSheetData.dynamic.ability.forEach(ability => {
            const abilityCard = document.getElementById(ability.id);
            if (abilityCard) {
                const ticks = abilityCard.querySelectorAll('.ability-use-tick');
                ability.usedStates = Array.from(ticks).map(tick => tick.classList.contains('used'));
            }
        });

        dataStore.characterSheetData.staticInputs['currentAbilityFilter'] = currentAbilityFilter;
        dataStore.characterSheetData.staticInputs['ability-search'] = document.getElementById('ability-search').value;
        dataStore.characterSheetData.staticInputs.questReminderEnabled = document.getElementById('toggle-quest-reminder').checked;
        
        // NEW: Save audio settings
        dataStore.characterSheetData.audio.musicVolume = document.getElementById('music-volume').value;
        dataStore.characterSheetData.audio.sfxVolume = document.getElementById('sfx-volume').value;
        dataStore.characterSheetData.audio.sfxLoop = document.getElementById('sfx-loop-toggle').checked;

        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(dataStore.characterSheetData));
            console.log("Ficha salva localmente.");
        } catch (e) {
            console.error("Erro ao salvar dados no localStorage:", e);
            showToast("Erro: Ficha muito grande para salvar. Exporte e limpe para continuar.", "error");
        }
    }

    function loadFromLocalStorage() {
        const savedData = localStorage.getItem(STORAGE_KEY);
        if (!savedData) {
            Object.keys(dataStore.characterSheetData.staticInputs).forEach(id => {
                const el = document.getElementById(id);
                if (el && el.id.startsWith('editor-')) {
                    setQuillEditorContent(el.id.replace('editor-', ''), dataStore.characterSheetData.staticInputs[id]);
                } else if (el && el.type !== 'file') {
                    el.value = dataStore.characterSheetData.staticInputs[id];
                }
            });
            updateAllCalculations(); 
            return;
        }

        try {
            const loadedSheetData = JSON.parse(savedData);
            // Deep merge to ensure new properties exist if loading older save
            Object.assign(dataStore.characterSheetData, loadedSheetData); 
            dataStore.characterSheetData.dynamic = dataStore.characterSheetData.dynamic || {};
            dataStore.characterSheetData.dynamic.item = dataStore.characterSheetData.dynamic.item || [];
            dataStore.characterSheetData.dynamic.journal = dataStore.characterSheetData.dynamic.journal || [];
            dataStore.characterSheetData.dynamic.ability = dataStore.characterSheetData.dynamic.ability || [];
            dataStore.characterSheetData.dynamic.bond = dataStore.characterSheetData.dynamic.bond || [];
            dataStore.characterSheetData.dynamic.weapon = dataStore.characterSheetData.dynamic.weapon || [];
            dataStore.characterSheetData.dynamic.quest = dataStore.characterSheetData.dynamic.quest || [];
            dataStore.characterSheetData.equippedItems = dataStore.characterSheetData.equippedItems || { "main-weapon": null, "offhand": null, "armor": null, "other": null };
            // NEW: Ensure audio data structure exists
            dataStore.characterSheetData.audio = dataStore.characterSheetData.audio || {
                musicPlaylist: [],
                currentTrackIndex: 0,
                musicVolume: 50,
                sfxSource: null,
                sfxVolume: 50,
                sfxLoop: false
            };


            for (const id in dataStore.characterSheetData.staticInputs) {
                const el = document.getElementById(id);
                if (el && el.type !== 'file') {
                    if (id.startsWith('personality-traits') || id.startsWith('ideals') || id.startsWith('bonds-backstory') || id.startsWith('flaws') || id.startsWith('backstory') || id.startsWith('item-bonus') || id.startsWith('journal-content') || id.startsWith('ability-desc') || id.startsWith('bond-summary') || id.startsWith('weapon-properties') || id.startsWith('quest-description')) {
                        setQuillEditorContent(`editor-${id}`, dataStore.characterSheetData.staticInputs[id]);
                    } else {
                        el.value = dataStore.characterSheetData.staticInputs[id];
                    }
                }
            }

            for (const key in dataStore.characterSheetData.toggles) {
                const el = document.getElementById(key) || document.querySelector(`[data-name="${key}"]`) || document.querySelector(`[title="${key}"]`);
                if (el) {
                    if (el.classList.contains('death-save')) {
                        if (dataStore.characterSheetData.toggles[key]) {
                            el.classList.add('filled');
                        } else {
                            el.classList.remove('filled');
                        }
                    } else if (el.classList.contains('proficiency-toggle')) {
                        el.classList.remove('proficient', 'expertise');
                        if (dataStore.characterSheetData.toggles[key] === 'proficient') {
                            el.classList.add('proficient');
                            el.textContent = 'P';
                        } else if (dataStore.characterSheetData.toggles[key] === 'expertise') {
                            el.classList.add('expertise');
                            el.textContent = 'E';
                        } else {
                            el.textContent = '';
                        }
                    } else if (el.classList.contains('advantage-toggle') || el.classList.contains('condition-token') || el.id === 'inspiration-tracker') {
                        if (dataStore.characterSheetData.toggles[key]) {
                            el.classList.add('active');
                        } else {
                            el.classList.remove('active');
                        }
                    }
                }
            }

            document.getElementById('char-img-preview').src = dataStore.characterSheetData.images.charImage || "https://placehold.co/100x100/c8a06e/4a2c2a?text=Icon";
            document.body.style.backgroundImage = dataStore.characterSheetData.images.wallpaper || "url('https://www.transparenttextures.com/patterns/old-wall.png')";

            currentAbilityFilter = dataStore.characterSheetData.staticInputs['currentAbilityFilter'] || 'All';
            const savedSearchTerm = dataStore.characterSheetData.staticInputs['ability-search'] || '';
            document.getElementById('ability-search').value = savedSearchTerm;
            document.getElementById('toggle-quest-reminder').checked = dataStore.characterSheetData.staticInputs.questReminderEnabled;
            
            const dynamicSections = ['item', 'journal', 'ability', 'bond', 'weapon', 'quest'];
            dynamicSections.forEach(type => {
                if (dataStore.characterSheetData.dynamic[type]) {
                    renderDynamicList(type, dataStore.characterSheetData.dynamic[type]);
                }
            });

            updateEquippedItemsUI();
            applyThemeFromData();
            updateAllCalculations();
            console.log("Ficha carregada do armazenamento local.");

            // NEW: Load audio settings and initialize players
            if (document.getElementById('music-volume')) {
                document.getElementById('music-volume').value = dataStore.characterSheetData.audio.musicVolume;
                backgroundMusicAudio.volume = dataStore.characterSheetData.audio.musicVolume / 100;
            }
            if (document.getElementById('sfx-volume')) {
                document.getElementById('sfx-volume').value = dataStore.characterSheetData.audio.sfxVolume;
                sfxAudio.volume = dataStore.characterSheetData.audio.sfxVolume / 100;
            }
            if (document.getElementById('sfx-loop-toggle')) {
                document.getElementById('sfx-loop-toggle').checked = dataStore.characterSheetData.audio.sfxLoop;
                sfxAudio.loop = dataStore.characterSheetData.audio.sfxLoop;
            }
            updateMusicPlaylistUI(); // Populate playlist in settings
            if (dataStore.characterSheetData.audio.sfxSource) {
                sfxAudio.src = dataStore.characterSheetData.audio.sfxSource;
                document.getElementById('sfx-name').textContent = "SFX Carregado"; // Or parse name from dataUrl
                document.getElementById('play-sfx-preview').classList.remove('hidden');
            }
            if (dataStore.characterSheetData.audio.musicPlaylist.length > 0) {
                backgroundMusicAudio.src = dataStore.characterSheetData.audio.musicPlaylist[dataStore.characterSheetData.audio.currentTrackIndex]?.data || '';
                document.getElementById('current-track-name').textContent = dataStore.characterSheetData.audio.musicPlaylist[dataStore.characterSheetData.audio.currentTrackIndex]?.name || 'Música';
                // Autoplay music if it was playing previously (careful with browser policies)
                if (isPlayingMusic && !backgroundMusicAudio.paused) {
                    backgroundMusicAudio.play().catch(e => console.log("Autoplay blocked:", e));
                }
            }


        } catch (e) {
            console.error("Erro ao carregar ou analisar dados do localStorage. Iniciando ficha nova.", e);
            showToast("Erro ao carregar a ficha. Reiniciando dados. Detalhes: " + e.message, "error", 5000);
            localStorage.removeItem(STORAGE_KEY);
            dataStore.characterSheetData = { 
                staticInputs: {
                    "char-name": "", "char-race": "", "char-origin": "",
                    "char-level": "1", "ac": "10", "speed": "30ft",
                    "hp-current": "0", "hp-max": "1",
                    "coins-cp": "0", "coins-sp": "0", "coins-gp": "0", "coins-pp": "0",
                    "personality-traits": "", "ideals": "", "bonds-backstory": "", "flaws": "", "backstory": "",
                    "journal-title": "", "journal-date": "", "journal-content": "",
                    "ability-name": "", "ability-desc": "", "ability-uses": "", "ability-reset": "none", "ability-category": "Geral",
                    "bond-name": "", "bond-relationship": "", "bond-summary": "",
                    "weapon-name": "", "weapon-damage": "", "weapon-type": "", "weapon-properties": "", "weapon-attribute": "STR",
                    "currentAbilityFilter": "All",
                    "ability-search": "",
                    "questReminderEnabled": true 
                }, 
                equippedItems: {
                    "main-weapon": null, "offhand": null, "armor": null, "other": null
                },
                toggles: {}, 
                dynamic: { item: [], journal: [], ability: [], bond: [], weapon: [], quest: [] },
                images: { charImage: "https://placehold.co/100x100/c8a06e/4a2c2a?text=Icon", wallpaper: "url('https://www.transparenttextures.com/patterns/old-wall.png')" },
                theme: 'light',
                audio: { // Reset audio to defaults
                    musicPlaylist: [],
                    currentTrackIndex: 0,
                    musicVolume: 50,
                    sfxSource: null,
                    sfxVolume: 50,
                    sfxLoop: false
                }
            };
            document.getElementById('char-level').value = "1";
            document.getElementById('ac').value = "10";
            document.getElementById('speed').value = "30ft";
            document.getElementById('hp-current').value = "0";
            document.getElementById('hp-max').value = "1";
            document.getElementById('coins-cp').value = "0";
            document.getElementById('coins-sp').value = "0";
            document.getElementById('coins-gp').value = "0";
            document.getElementById('coins-pp').value = "0";

            for (const editorId in quillEditors) {
                quillEditors[editorId].setContents([]);
            }

            document.querySelectorAll('.ability-filter-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.ability-filter-button[data-filter="All"]').classList.add('active');

            updateEquippedItemsUI();
            updateAllCalculations();
        }
    }


    // --- Dice Roller Functions ---
    function rollDice(sides) {
        const result = Math.floor(Math.random() * sides) + 1;
        const diceResultElement = document.getElementById('dice-result');
        diceResultElement.textContent = `D${sides}: ${result}`;
        vibrate(100);
        diceResultElement.classList.add('modifier-flash');
        diceResultElement.addEventListener('animationend', () => {
            diceResultElement.classList.remove('modifier-flash');
        }, { once: true });
    }

    function rollAttack(weaponId) {
        const weaponData = dataStore.characterSheetData.dynamic.weapon.find(weapon => weapon.id === weaponId);
        if (!weaponData) {
            showToast('Arma não encontrada para rolar ataque.', 'error');
            return;
        }

        const profBonus = getProficiencyBonus();
        const attributeModifier = getAttributeModifier(weaponData.attribute);
        const attackRoll = Math.floor(Math.random() * 20) + 1;
        const totalAttackBonus = attackRoll + attributeModifier + profBonus;

        const diceResultElement = document.getElementById('dice-result');
        diceResultElement.innerHTML = `
            <p class="text-lg">Ataque com ${weaponData.name}:</p>
            <p class="text-2xl font-bold">D20 (${attackRoll}) + ${attributeModifier >= 0 ? '+' : ''}${attributeModifier} (Mod. ${weaponData.attribute}) + ${profBonus} (Prof.) = <span class="text-4xl">${totalAttackBonus}</span></p>
        `;
        vibrate(150);
        diceResultElement.classList.add('modifier-flash');
        diceResultElement.addEventListener('animationend', () => {
            diceResultElement.classList.remove('modifier-flash');
        }, { once: true });
    }

    function rollDamageForWeapon(weaponId) {
        const weaponData = dataStore.characterSheetData.dynamic.weapon.find(weapon => weapon.id === weaponId);
        if (!weaponData) {
            showToast('Arma não encontrada para rolar dano.', 'error');
            return;
        }

        const damageString = weaponData.damage;
        const attributeModifier = getAttributeModifier(weaponData.attribute);

        const damageResult = rollDamage(damageString, attributeModifier);

        const diceResultElement = document.getElementById('dice-result');
        diceResultElement.innerHTML = `
            <p class="text-lg">Dano de ${weaponData.name}:</p>
            <p class="text-2xl font-bold">${damageResult.details} = <span class="text-4xl">${damageResult.total}</span></p>
        `;
        vibrate(150);
        diceResultElement.classList.add('modifier-flash');
        diceResultElement.addEventListener('animationend', () => {
            diceResultElement.classList.remove('modifier-flash');
        }, { once: true });
    }

    function rollDamage(damageString, modifier = 0) {
        let totalDamage = 0;
        let details = [];
        
        const cleanedDamageString = damageString.toLowerCase().replace(/\s/g, '');

        const regex = /(\d+d\d+)|([+-]?\d+)/g;
        let match;

        while ((match = regex.exec(cleanedDamageString)) !== null) {
            if (match[1]) {
                const [numDice, sides] = match[1].split('d').map(Number);
                let diceRolls = [];
                let currentDiceTotal = 0;
                for (let i = 0; i < numDice; i++) {
                    const roll = Math.floor(Math.random() * sides) + 1;
                    diceRolls.push(roll);
                    currentDiceTotal += roll;
                }
                totalDamage += currentDiceTotal;
                details.push(`${match[1]} (${diceRolls.join('+')})`);
            } else if (match[2]) {
                const flatValue = parseInt(match[2]);
                totalDamage += flatValue;
                details.push(`${flatValue >= 0 ? '+' : ''}${flatValue}`);
            }
        }

        totalDamage += modifier;
        if (modifier !== 0) {
            details.push(`${modifier >= 0 ? '+' : ''}${modifier} (Mod. de Atributo)`);
        }

        return {
            total: totalDamage,
            details: details.join(' ')
        };
    }

    // --- Export and Import Functions ---
    function exportCharacterSheet() {
        try {
            saveToLocalStorage(); 
            const dataStr = JSON.stringify(dataStore.characterSheetData, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            
            const now = new Date();
            const dateString = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
            const charName = document.getElementById('char-name').value.replace(/\s/g, '_') || 'personagem';
            const filename = `ficha_${charName}_${dateString}.json`;

            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast("Ficha exportada com sucesso!", "success");
        } catch (e) {
            console.error("Erro ao exportar ficha:", e);
            showToast("Erro ao exportar a ficha. Verifique o console.", "error");
        }
    }

    function importCharacterSheet(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedData = JSON.parse(e.target.result);
                if (importedData && typeof importedData === 'object' && 
                    importedData.staticInputs && importedData.dynamic && importedData.images) {
                    if (confirm('Importar esta ficha irá substituir TODOS os dados atuais. Deseja continuar?')) {
                        localStorage.setItem(STORAGE_KEY, e.target.result); 
                        showToast("Ficha importada com sucesso! Recarregando...", "success");
                        setTimeout(() => location.reload(), 1000);
                    }
                } else {
                    showToast("Arquivo JSON inválido. Certifique-se de que é um arquivo de exportação de ficha válido.", "error");
                }
            } catch (error) {
                console.error("Erro ao analisar o arquivo de importação:", error);
                showToast("Erro ao ler o arquivo. Certifique-se de que é um JSON válido. Detalhes: " + error.message, "error");
            }
        };
        reader.readAsText(file);
    }

    function resetCharacterSheetConfirm() {
        if (confirm('Tem certeza que deseja REDEFINIR a ficha? Todos os dados serão PERDIDOS permanentemente.')) {
            localStorage.removeItem(STORAGE_KEY);
            showToast("Ficha redefinida! Recarregando...", "success");
            setTimeout(() => location.reload(), 1000);
        }
    }

    // --- Equipped Items & Select Item Modal Functions ---

    function updateEquippedItemsUI() {
        const equippedItems = dataStore.characterSheetData.equippedItems;

        for (const slotName in equippedItems) {
            const slotElement = document.getElementById(`equipped-slot-${slotName}`);
            const slotNameSpan = slotElement.querySelector('.slot-name');
            const clearButton = slotElement.querySelector('.clear-button');

            const equippedItemData = equippedItems[slotName];

            if (equippedItemData) {
                let item = null;
                if (equippedItemData.type === 'item') {
                    item = dataStore.characterSheetData.dynamic.item.find(i => i.id === equippedItemData.id);
                } else if (equippedItemData.type === 'weapon') {
                    item = dataStore.characterSheetData.dynamic.weapon.find(w => w.id === equippedItemData.id);
                }

                if (item) {
                    slotNameSpan.textContent = item.name;
                    slotElement.classList.remove('empty');
                    clearButton.classList.remove('hidden');
                } else {
                    equippedItems[slotName] = null;
                    slotNameSpan.textContent = "Nenhum";
                    slotElement.classList.add('empty');
                    clearButton.classList.add('hidden');
                }
            } else {
                slotNameSpan.textContent = "Nenhum";
                slotElement.classList.add('empty');
                clearButton.classList.add('hidden');
            }
        }
        saveToLocalStorage();
    }

    function openSelectItemModal() {
        openModal('select-item-modal');
        document.getElementById('select-item-search').value = '';
        document.querySelectorAll('.select-item-filter').forEach(btn => btn.classList.remove('active'));
        document.querySelector('.select-item-filter[data-filter-type="all"]').classList.add('active');
        populateSelectItemModal();
    }

    function populateSelectItemModal(filterType = 'all') {
        const listElement = document.getElementById('item-select-list');
        listElement.innerHTML = '';
        const searchTerm = document.getElementById('select-item-search').value.toLowerCase();

        let availableItems = [];

        if (filterType === 'all' || filterType === 'item') {
            dataStore.characterSheetData.dynamic.item.forEach(item => {
                if (item.name.toLowerCase().includes(searchTerm) || item.type.toLowerCase().includes(searchTerm)) {
                    availableItems.push({ ...item, itemType: 'item' });
                }
            });
        }

        if (filterType === 'all' || filterType === 'weapon') {
            dataStore.characterSheetData.dynamic.weapon.forEach(weapon => {
                if (weapon.name.toLowerCase().includes(searchTerm) || weapon.type.toLowerCase().includes(searchTerm) || (weapon.properties && weapon.properties.toLowerCase().includes(searchTerm))) {
                    availableItems.push({ ...weapon, itemType: 'weapon' });
                }
            });
        }

        if (availableItems.length === 0) {
            listElement.innerHTML = '<p class="text-center opacity-70 p-4">Nenhum item ou arma encontrado.</p>';
            return;
        }

        availableItems.sort((a, b) => a.name.localeCompare(b.name));

        availableItems.forEach(item => {
            let img = '';
            let typeLabel = '';
            if (item.itemType === 'item') {
                img = item.img && item.img.startsWith('data:image') ? item.img : 'https://placehold.co/40x40/d4a778/5a403a?text=I';
                typeLabel = `Item (${item.type})`;
            } else { // weapon
                img = item.img && item.img.startsWith('data:image') ? item.img : 'https://placehold.co/40x40/d4a778/5a403a?text=W';
                typeLabel = `Arma (${item.type})`;
            }

            listElement.innerHTML += `
                <div class="item-select-card" data-id="${item.id}" data-type="${item.itemType}">
                    <img src="${img}" alt="${item.name}">
                    <div>
                        <div class="item-select-name">${item.name}</div>
                        <div class="item-select-type">${typeLabel}</div>
                    </div>
                </div>
            `;
        });
    }

    function equipItemToSlot(slotName, itemType, itemId) {
        let itemData = null;
        if (itemType === 'item') {
            itemData = dataStore.characterSheetData.dynamic.item.find(i => i.id === itemId);
        } else if (itemType === 'weapon') {
            itemData = dataStore.characterSheetData.dynamic.weapon.find(w => w.id === itemId);
        }

        if (itemData) {
            dataStore.characterSheetData.equippedItems[slotName] = { id: itemId, type: itemType };
            updateEquippedItemsUI();
            showToast(`${itemData.name} equipado em ${slotName.replace('-', ' ')}.`, 'success');
        } else {
            showToast('Item/arma não encontrado para equipar.', 'error');
        }
    }

    function clearEquippedSlot(slotName) {
        dataStore.characterSheetData.equippedItems[slotName] = null;
        updateEquippedItemsUI();
        showToast(`Slot de ${slotName.replace('-', ' ')} limpo.`, 'success');
    }

    // --- NEW: Audio Playback Functions ---
    function setupAudioPlayer() {
        backgroundMusicAudio.loop = true; // Music loops by default
        backgroundMusicAudio.volume = dataStore.characterSheetData.audio.musicVolume / 100;
        sfxAudio.loop = dataStore.characterSheetData.audio.sfxLoop;
        sfxAudio.volume = dataStore.characterSheetData.audio.sfxVolume / 100;

        // Try to resume music if it was playing when page was last closed
        if (dataStore.characterSheetData.audio.musicPlaylist.length > 0 && dataStore.characterSheetData.audio.currentTrackIndex !== undefined) {
            const currentTrack = dataStore.characterSheetData.audio.musicPlaylist[dataStore.characterSheetData.audio.currentTrackIndex];
            if (currentTrack && currentTrack.data) {
                backgroundMusicAudio.src = currentTrack.data;
                document.getElementById('current-track-name').textContent = currentTrack.name || 'Música Desconhecida';
                // Autoplay might be blocked by browsers, so play/pause button will be the primary control
            }
        }
    }

    function toggleAudioPlayerPopup() {
        const popup = document.getElementById('audio-player-popup');
        popup.classList.toggle('visible');
    }

    function toggleMusicPlayPause() {
        const playPauseBtn = document.getElementById('play-pause-btn');
        const playIcon = playPauseBtn.querySelector('.fa-play');
        const pauseIcon = playPauseBtn.querySelector('.fa-pause');

        if (backgroundMusicAudio.paused) {
            if (backgroundMusicAudio.src) {
                backgroundMusicAudio.play()
                    .then(() => {
                        isPlayingMusic = true;
                        if (playIcon) playIcon.classList.replace('fa-play', 'fa-pause');
                        showToast(`Reproduzindo: ${document.getElementById('current-track-name').textContent}`, 'success');
                    })
                    .catch(e => {
                        console.error("Erro ao reproduzir música (provavelmente autoplay bloqueado):", e);
                        showToast("A reprodução de música foi bloqueada pelo navegador. Tente interagir com a página primeiro.", 'error');
                        isPlayingMusic = false; // Ensure state is correct
                        if (pauseIcon) pauseIcon.classList.replace('fa-pause', 'fa-play');
                    });
            } else {
                showToast("Nenhuma música carregada na playlist.", 'error');
            }
        } else {
            backgroundMusicAudio.pause();
            isPlayingMusic = false;
            if (pauseIcon) pauseIcon.classList.replace('fa-pause', 'fa-play');
            showToast("Música pausada.", 'success');
        }
    }

    function playMusicTrack(index) {
        if (dataStore.characterSheetData.audio.musicPlaylist.length === 0) {
            showToast("Nenhuma música na playlist.", 'error');
            return;
        }
        if (index < 0) index = dataStore.characterSheetData.audio.musicPlaylist.length - 1;
        if (index >= dataStore.characterSheetData.audio.musicPlaylist.length) index = 0;

        dataStore.characterSheetData.audio.currentTrackIndex = index;
        const currentTrack = dataStore.characterSheetData.audio.musicPlaylist[index];
        backgroundMusicAudio.src = currentTrack.data;
        document.getElementById('current-track-name').textContent = currentTrack.name || 'Música Desconhecida';
        
        backgroundMusicAudio.play().then(() => {
            isPlayingMusic = true;
            const playPauseBtn = document.getElementById('play-pause-btn');
            const playIcon = playPauseBtn.querySelector('.fa-play');
            const pauseIcon = playPauseBtn.querySelector('.fa-pause');
            if (playIcon) playIcon.classList.replace('fa-play', 'fa-pause');
            if (!playIcon && !pauseIcon) { // Initial state, add pause icon directly
                playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
            }
            showToast(`Reproduzindo: ${currentTrack.name}`, 'success');
        }).catch(e => {
            console.error("Erro ao reproduzir música:", e);
            showToast("Não foi possível reproduzir a música. Pode ser que o navegador tenha bloqueado o autoplay.", 'error');
            isPlayingMusic = false;
            const playPauseBtn = document.getElementById('play-pause-btn');
            const pauseIcon = playPauseBtn.querySelector('.fa-pause');
            if (pauseIcon) pauseIcon.classList.replace('fa-pause', 'fa-play');
        });
        saveToLocalStorage();
    }

    function playNextTrack() {
        let nextIndex = dataStore.characterSheetData.audio.currentTrackIndex + 1;
        if (nextIndex >= dataStore.characterSheetData.audio.musicPlaylist.length) {
            nextIndex = 0; // Loop back to the start
        }
        playMusicTrack(nextIndex);
    }

    function playPrevTrack() {
        let prevIndex = dataStore.characterSheetData.audio.currentTrackIndex - 1;
        if (prevIndex < 0) {
            prevIndex = dataStore.characterSheetData.audio.musicPlaylist.length - 1; // Loop to the end
        }
        playMusicTrack(prevIndex);
    }

    function handleMusicFileSelect(event) {
        const files = Array.from(event.target.files);
        if (files.length === 0) return;

        const newPlaylistItems = [];
        let filesProcessed = 0;

        files.forEach(file => {
            if (file.type.startsWith('audio/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    newPlaylistItems.push({
                        name: file.name,
                        data: e.target.result
                    });
                    filesProcessed++;
                    if (filesProcessed === files.length) {
                        dataStore.characterSheetData.audio.musicPlaylist = newPlaylistItems;
                        dataStore.characterSheetData.audio.currentTrackIndex = 0; // Reset index to first track
                        updateMusicPlaylistUI();
                        playMusicTrack(0); // Start playing the first newly loaded track
                        showToast(`Carregadas ${files.length} músicas na playlist!`, 'success');
                        saveToLocalStorage();
                    }
                };
                reader.readAsDataURL(file);
            } else {
                showToast(`O arquivo ${file.name} não é um formato de áudio suportado.`, 'error');
                filesProcessed++; // Still count as processed to finish loading
            }
        });
    }

    function updateMusicPlaylistUI() {
        const playlistContainer = document.getElementById('music-playlist');
        playlistContainer.innerHTML = '';
        if (dataStore.characterSheetData.audio.musicPlaylist.length === 0) {
            playlistContainer.innerHTML = '<p class="text-sm opacity-70 text-center">Nenhuma música carregada.</p>';
            return;
        }

        dataStore.characterSheetData.audio.musicPlaylist.forEach((track, index) => {
            const trackElement = document.createElement('div');
            trackElement.className = 'flex items-center justify-between text-sm py-1 border-b border-[var(--border-color)] last:border-b-0';
            trackElement.innerHTML = `
                <span class="flex-grow text-left">${track.name}</span>
                <div>
                    <button class="text-red-700 hover:text-red-900 px-1" data-track-index="${index}" data-action="remove-track"><i class="fas fa-trash-alt"></i></button>
                    <button class="text-green-700 hover:text-green-900 px-1" data-track-index="${index}" data-action="play-track"><i class="fas fa-play"></i></button>
                </div>
            `;
            playlistContainer.appendChild(trackElement);
        });

        // Add listeners for dynamically created playlist buttons
        playlistContainer.querySelectorAll('button[data-action="remove-track"]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const indexToRemove = parseInt(e.currentTarget.dataset.trackIndex);
                removeMusicTrack(indexToRemove);
            });
        });
        playlistContainer.querySelectorAll('button[data-action="play-track"]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const indexToPlay = parseInt(e.currentTarget.dataset.trackIndex);
                playMusicTrack(indexToPlay);
            });
        });
    }

    function removeMusicTrack(index) {
        if (index > -1 && index < dataStore.characterSheetData.audio.musicPlaylist.length) {
            const removedTrack = dataStore.characterSheetData.audio.musicPlaylist.splice(index, 1);
            showToast(`Música "${removedTrack[0]?.name || 'desconhecida'}" removida.`, 'success');

            // Adjust current track index if necessary
            if (dataStore.characterSheetData.audio.currentTrackIndex === index) {
                backgroundMusicAudio.pause();
                backgroundMusicAudio.src = '';
                document.getElementById('current-track-name').textContent = 'Nenhuma Música';
                isPlayingMusic = false;
                const playPauseBtn = document.getElementById('play-pause-btn');
                const pauseIcon = playPauseBtn.querySelector('.fa-pause');
                if (pauseIcon) pauseIcon.classList.replace('fa-pause', 'fa-play');
                dataStore.characterSheetData.audio.currentTrackIndex = 0; // Reset index to start
            } else if (dataStore.characterSheetData.audio.currentTrackIndex > index) {
                dataStore.characterSheetData.audio.currentTrackIndex--; // Decrement index if track before it was removed
            }
            updateMusicPlaylistUI();
            saveToLocalStorage();
        }
    }

    function handleSfxFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (file.type.startsWith('audio/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                dataStore.characterSheetData.audio.sfxSource = e.target.result;
                sfxAudio.src = e.target.result;
                document.getElementById('sfx-name').textContent = file.name;
                document.getElementById('play-sfx-preview').classList.remove('hidden');
                showToast(`Efeito sonoro "${file.name}" carregado!`, 'success');
                saveToLocalStorage();
            };
            reader.readAsDataURL(file);
        } else {
            showToast(`O arquivo ${file.name} não é um formato de áudio suportado para SFX.`, 'error');
        }
    }

</script>

</body>
</html>
